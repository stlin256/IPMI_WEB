<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>系统日志 - {{ server_name }} Ops</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <style>
        :root { 
            --bg-body: #0d1117; 
            --border-color: #30363d; 
            --text-main: #e6edf3; 
            --text-muted: #8b949e;
            --text-success: #3fb950;
            --text-danger: #f85149;
            --text-warning: #d29922;
            --text-blue: #58a6ff;
            --accent-blue: #1f6feb;
            --accent-red: #f85149;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
        }
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: "Segoe UI", sans-serif;
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 13px;
        }
        
        /* 统一导航栏样式 */
        .navbar { 
            background-color: rgba(22, 27, 34, 0.95) !important; 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0;
        }
        .nav-link { color: var(--text-muted) !important; font-weight: 500; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { color: #fff !important; }
        
        /* CLI 风格容器 */
        .cli-container { 
            padding: 0 20px;
            max-width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-top: 1rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .cli-line {
            display: flex;
            align-items: flex-start;
            padding: 8px 0;
            line-height: 1.5;
            border-bottom: 1px solid rgba(48, 54, 61, 0.3);
        }
        .cli-line:last-child { border-bottom: none; }
        
        .cli-time {
            color: var(--text-muted);
            min-width: 140px;
            flex-shrink: 0;
        }
        
        .cli-status {
            min-width: 80px;
            flex-shrink: 0;
            font-weight: 600;
        }
        .cli-status.success { color: var(--text-success); }
        .cli-status.fail { color: var(--text-danger); }
        .cli-status.warn { color: var(--text-warning); }
        .cli-status.info { color: var(--text-blue); }
        
        .cli-content {
            flex-grow: 1;
            word-break: break-all;
            font-family: 'SF Mono', 'Consolas', 'Monaco', 'Menlo', monospace;
        }
        
n        /* 标签样式 */
        .cli-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .cli-tag-ip { 
            background: rgba(31, 111, 235, 0.15); 
            color: var(--text-blue); 
            border-color: rgba(31, 111, 235, 0.3); 
        }
        .cli-tag-ip:hover { background: rgba(31, 111, 235, 0.25); }
        .cli-tag-ua { 
            background: rgba(139, 148, 158, 0.15); 
            color: var(--text-muted); 
            border-color: rgba(139, 148, 158, 0.3); 
        }
        .cli-tag-ua:hover { background: rgba(139, 148, 158, 0.25); color: var(--text-main); }
        
        /* 高亮效果 */
        .highlighted .cli-tag-ip {
            background: rgba(31, 111, 235, 0.4) !important;
            border-color: var(--accent-blue) !important;
            box-shadow: 0 0 12px rgba(31, 111, 235, 0.5);
        }
        .highlighted .cli-tag-ua {
            background: rgba(31, 111, 235, 0.3) !important;
            border-color: var(--accent-blue) !important;
        }
        
        /* 详情折叠区 - 全宽度显示 */
        .cli-details {
            margin: 8px 0;
            padding: 16px;
            background: rgba(13, 17, 23, 0.95);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .cli-details pre {
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            font-family: 'SF Mono', 'Consolas', 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-muted);
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* 折叠动画 */
        .cli-details.collapse {
            display: none;
        }
        .cli-details.collapse.show {
            display: block;
            animation: slideDown 0.25s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 500px;
            }
        }
        
        .cli-details-title {
            color: var(--text-muted);
            font-size: 11px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .cli-history-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
            font-size: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .cli-history-item:last-child { border-bottom: none; }
        .cli-history-time {
            color: var(--text-muted);
            min-width: 130px;
        }
        .cli-history-status {
            min-width: 70px;
        }
        .cli-history-msg {
            color: var(--text-muted);
        }
        
        .terminal-body {
            background: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        /* 刷新指示器 */
        .refresh-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-success);
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .cli-line { flex-wrap: wrap; }
            .cli-time { min-width: 100px; font-size: 11px; }
            .cli-status { min-width: 60px; font-size: 11px; }
            .cli-details { margin-left: 0; padding: 10px; }
            .cli-history-item { flex-wrap: wrap; }
            .cli-history-time { min-width: 80px; }
            
            /* 系统设置 Modal 移动端优化 */
            #settingsModal .modal-body { flex-direction: column !important; }
            #settingsModal .border-end { border-end-width: 0 !important; border-bottom: 1px solid var(--border-color) !important; width: 100% !important; flex-shrink: 0; }
            #settingsModal .nav { flex-direction: row !important; overflow-x: auto; overflow-y: hidden; }
            #settingsModal .nav-link { flex-shrink: 0; padding: 12px 16px !important; }
            #settingsModal .tab-content { max-height: 60vh; }
            
            /* 页面标题栏按钮移动端优化 */
            .d-flex.flex-wrap.justify-content-between { gap: 10px !important; }
            .d-flex.align-items-center.gap-3 { gap: 10px !important; flex-wrap: wrap; }
            .d-flex.align-items-center.gap-2 { gap: 8px !important; flex-wrap: wrap; justify-content: flex-end; }
            .btn-sm { padding: 6px 12px !important; font-size: 12px !important; }
        }
        
        /* 滚动条美化 */
        .terminal-body::-webkit-scrollbar { width: 8px; }
        .terminal-body::-webkit-scrollbar-track { background: var(--bg-body); }
        .terminal-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .terminal-body::-webkit-scrollbar-thumb:hover { background: #484f58; }

        /* 动画效果 */
        .fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-pane.active { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .rule-card {
            transition: all 0.2s ease;
            border: 1px solid var(--border-color) !important;
            background: rgba(255,255,255,0.02) !important;
        }
        .rule-card:hover { border-color: var(--accent-blue) !important; background: rgba(255,255,255,0.04) !important; }

        /* 1. 图表容器比例 */
        .interval-chart-container {
            background: rgba(22, 27, 34, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            width: 100%;
            aspect-ratio: 15 / 1;
            min-height: 80px;
            position: relative;
            display: flex;
            align-items: flex-end;
            overflow: hidden;
        }

        .chart-loading {
            background: rgba(13, 17, 23, 0.8) !important;
        }

        /* 流光动画 */
        .chart-loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: -150%;
            width: 150%;
            height: 100%;
            background: linear-gradient(
                90deg, 
                transparent 25%, 
                rgba(255, 255, 255, 0.06) 50%, 
                transparent 75%
            );
            animation: chart-shimmer 1.5s infinite linear;
        }
        @keyframes chart-shimmer {
            0% { left: -150%; }
            100% { left: 150%; }
        }

        .interval-chart-canvas {
            width: 100%;
            height: 100%;
            image-rendering: auto;
        }

        /* 2. 标题微调 */
        .chart-label {
            position: absolute;
            top: 10px;
            left: 12px;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2;
            font-weight: 600;
        }

        /* 3. 极值标注组 - 放在顶部靠右排列 */
        .chart-markers-group {
            position: absolute;
            top: 10px;
            right: 12px;
            display: flex;
            gap: 15px;
            z-index: 2;
        }

        .chart-value-marker {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 11px;
            font-weight: bold;
            padding: 1px 6px;
            background: rgba(13, 17, 23, 0.8);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: color 0.3s ease;
        }

        /* Chart tooltip */
        .chart-tooltip {
            position: absolute;
            background: rgba(13, 17, 23, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 11px;
            color: var(--text-main);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 10;
            white-space: nowrap;
        }
        .chart-tooltip.visible {
            opacity: 1;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/hardware">
            <i class="fas fa-shield-alt me-2 text-warning"></i> <span class="fw-bold fs-4">{{ server_name }}</span>
        </a>
        <div class="navbar-nav flex-row ms-auto">
            <a class="btn btn-outline-secondary me-2" href="/hardware"><i class="fas fa-arrow-left"></i></a>
        </div>
    </div>
</nav>

<div class="container cli-container">
    <!-- Toast 容器 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 2000;">
        <div id="opToast" class="toast align-items-center text-white bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i> <span id="toast-msg">操作成功</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- 确认删除 Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" style="z-index: 2100;">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content bg-dark border-danger shadow-lg">
                <div class="modal-body p-4 text-center">
                    <i class="fas fa-exclamation-circle text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold">确认删除此规则？</h5>
                    <p class="text-muted small mb-4" id="confirm-msg">删除后将无法恢复</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary flex-grow-1" data-bs-dismiss="modal">取消</button>
                        <button class="btn btn-danger flex-grow-1 fw-bold" id="confirm-execute-btn">确认删除</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 综合设置 Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary py-2">
                    <h5 class="modal-title fs-6 text-muted-plus fw-bold"><i class="fas fa-cog me-2"></i>系统设置</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 d-flex" style="min-height: 450px;">
                    <!-- 左侧侧边栏 Tab -->
                    <div class="border-end border-secondary bg-black bg-opacity-25" style="width: 160px; flex-shrink: 0;">
                        <div class="nav flex-column nav-pills p-2" id="settings-tabs" role="tablist">
                            <button class="nav-link active text-start py-3 mb-1" data-bs-toggle="pill" data-bs-target="#tab-display" type="button">
                                <i class="fas fa-desktop me-2"></i> 图表设置
                            </button>
                            <button class="nav-link text-start py-3 mb-1" data-bs-toggle="pill" data-bs-target="#tab-storage" type="button">
                                <i class="fas fa-database me-2"></i> 存储管理
                            </button>
                            <button class="nav-link text-start py-3 mb-1" data-bs-toggle="pill" data-bs-target="#tab-alerts" type="button">
                                <i class="fas fa-bell me-2"></i> 告警规则
                            </button>
                        </div>
                    </div>
                    <!-- 右侧内容区 -->
                    <div class="tab-content p-4 flex-grow-1 overflow-auto" style="max-height: 550px;">
                        <!-- 图表设置 Tab -->
                        <div class="tab-pane fade show active" id="tab-display">
                            <h6 class="text-primary mb-4 fw-bold">采集延迟色彩阈值</h6>
                            <div class="row g-3 mb-5">
                                <div class="col-md-6">
                                    <label class="form-label text-warning small fw-bold">警告阈值 (WARN) - 黄色</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="set-warn" class="form-control bg-dark border-secondary text-light" step="0.1">
                                        <span class="input-group-text bg-dark border-secondary text-muted">秒</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-danger small fw-bold">危险阈值 (DANGER) - 红色</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="set-danger" class="form-control bg-dark border-secondary text-light" step="0.1">
                                        <span class="input-group-text bg-dark border-secondary text-muted">秒</span>
                                    </div>
                                </div>
                            </div>
                            
                            <h6 class="text-primary mb-4 fw-bold">页面看板小时级设置</h6>
                            <div class="mb-4">
                                <label class="form-label text-muted small fw-bold">Hardware 页面选项</label>
                                <div id="check-hw-hours" class="d-flex flex-wrap gap-2">
                                    <!-- 动态生成勾选框 -->
                                </div>
                                <div class="form-text text-muted-plus small mt-2">>24H 将自动转换为天 (D) 展示</div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label text-muted small fw-bold">History 页面选项</label>
                                <div id="check-hist-hours" class="d-flex flex-wrap gap-2">
                                    <!-- 动态生成勾选框 -->
                                </div>
                            </div>
                        </div>

                        <!-- 存储管理 Tab -->
                        <div class="tab-pane fade" id="tab-storage">
                            <h6 class="text-primary mb-4 fw-bold">数据保留策略</h6>
                            <div class="alert alert-info bg-info bg-opacity-10 border-info border-opacity-25 py-3 mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <span class="small text-info">缩短保留期后将有 3 天的“反悔期”。调回原时长可取消待处理的删除任务。</span>
                            </div>
                            <div class="mb-4">
                                <label class="form-label text-muted small fw-bold">数据保留时长 (天)</label>
                                <div class="input-group">
                                    <input type="number" id="set-retention" class="form-control bg-dark border-secondary text-light" min="7">
                                    <span class="input-group-text bg-dark border-secondary text-muted">天</span>
                                </div>
                                <div class="mt-3 d-flex justify-content-between align-items-center">
                                    <div id="retention-status"></div>
                                    <div class="text-muted small">
                                        <i class="fas fa-hdd me-1"></i>数据库占用: <span id="db-size-val" class="text-light fw-bold">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 告警规则 Tab -->
                        <div class="tab-pane fade" id="tab-alerts">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="text-primary mb-0 fw-bold">自定义告警</h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="addNewAlertRule()">
                                    <i class="fas fa-plus me-1"></i>添加规则
                                </button>
                            </div>
                            <div id="alert-rules-container" class="d-flex flex-column gap-2 pb-3">
                                <!-- 告警规则列表 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary py-2 bg-black bg-opacity-25">
                    <button class="btn btn-sm btn-outline-secondary px-4" data-bs-dismiss="modal">关闭</button>
                    <button class="btn btn-sm btn-primary px-5 fw-bold" id="btn-save-global" onclick="saveGlobalSettings()">
                        <span id="save-btn-text">应用并保存</span>
                        <i id="save-btn-spinner" class="fas fa-spinner fa-spin d-none"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入预览 Modal -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title fw-bold"><i class="fas fa-file-import me-2"></i>导入配置</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="import-precheck-view">
                        <div class="text-center py-5">
                            <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                            <h5>选择配置文件以开始</h5>
                            <button class="btn btn-primary mt-3 px-4" onclick="document.getElementById('config-upload').click()">选择 JSON 文件</button>
                        </div>
                    </div>
                    <div id="import-diff-view" class="d-none">
                        <div class="alert alert-info small py-2 mb-3 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-info-circle me-2"></i>
                                备份版本: <span id="import-version-val" class="fw-bold me-3">--</span>
                                导出时间: <span id="import-time-val" class="fw-bold">--</span>
                            </div>
                            <div class="text-muted">软件版本: <span id="import-sw-val">--</span></div>
                        </div>
                        <div class="alert alert-warning small py-2 mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>请勾选您希望导入的项目。若缩短保留期，将自动触发 3 天反悔期。
                        </div>
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-dark table-sm align-middle small">
                                <thead class="text-muted">
                                    <tr>
                                        <th width="40"><input type="checkbox" id="import-select-all" checked onchange="toggleImportSelectAll(this.checked)"></th>
                                        <th>设置项</th>
                                        <th>当前值</th>
                                        <th>导入值</th>
                                    </tr>
                                </thead>
                                <tbody id="import-diff-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="import-error-msg" class="alert alert-danger d-none small py-2 mt-3"></div>
                    <input type="file" id="config-upload" accept=".json" hidden onchange="handleImport(this.files)">
                </div>
                <div class="modal-footer border-secondary d-none" id="import-modal-footer">
                    <button class="btn btn-outline-secondary btn-sm px-4" data-bs-dismiss="modal">取消</button>
                    <button class="btn btn-success btn-sm px-4 fw-bold" onclick="executeImport()">确认导入</button>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div class="d-flex align-items-center gap-3">
            <h4 class="mb-0"><i class="fas fa-list me-2 text-primary"></i>系统日志</h4>
            <span class="refresh-indicator" id="refreshIndicator" title="自动刷新中"></span>
            <button class="btn btn-outline-secondary btn-sm px-3" onclick="openDelaySettings()">
                <i class="fas fa-cog me-1"></i>设置
            </button>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-primary btn-sm px-3" onclick="exportConfig()">
                <i class="fas fa-download me-1"></i>导出配置
            </button>
            <button class="btn btn-outline-success btn-sm px-3" onclick="openImportModal()">
                <i class="fas fa-upload me-1"></i>导入配置
            </button>
        </div>
    </div>

    <!-- 延迟设置 Modal -->
    <div class="modal fade" id="delayModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="fas fa-palette me-2"></i>延迟色彩阈值设置</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label text-warning small fw-bold">警告阈值 (WARN) - 黄色</label>
                        <div class="input-group">
                            <input type="number" id="input-warn" class="form-control bg-dark text-light border-secondary" step="0.1" min="0.1">
                            <span class="input-group-text bg-dark border-secondary text-muted">秒</span>
                        </div>
                        <div class="form-text text-muted">延迟超过此值且低于危险阈值时显示为黄色</div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label text-danger small fw-bold">危险阈值 (DANGER) - 红色</label>
                        <div class="input-group">
                            <input type="number" id="input-danger" class="form-control bg-dark text-light border-secondary" step="0.1" min="0.1">
                            <span class="input-group-text bg-dark border-secondary text-muted">秒</span>
                        </div>
                        <div class="form-text text-muted">延迟超过此值时显示为红色</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary fw-bold" onclick="saveDelaySettings()">
                            保存设置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 24H 采集延迟图表 -->
    <div class="interval-chart-container chart-loading" id="chart-wrapper">
        <div class="chart-label">
            <i class="fas fa-wave-square me-1"></i> 24H 采集延迟 (s)
        </div>
        
        <!-- 顶部标注组 -->
        <div class="chart-markers-group">
            <div class="chart-value-marker" id="chart-max-val">MAX: --</div>
            <div class="chart-value-marker" id="chart-avg-val">AVG: --</div>
            <div class="chart-value-marker" id="chart-min-val">MIN: --</div>
        </div>
        
        <canvas id="intervalCanvas" class="interval-chart-canvas"></canvas>
        <!-- Tooltip -->
        <div class="chart-tooltip" id="chart-tooltip"></div>
    </div>

    <!-- 日志容器 -->
    <div class="terminal-body" id="logs-container" style="border-radius: 8px;">
        <div class="text-center py-5 text-muted">
            <i class="fas fa-spinner fa-spin fa-lg mb-3"></i>
            <p>正在加载日志...</p>
        </div>
    </div>
</div>

<script>
    let importModal;

    function showToast(msg, isError = false) {
        const toastEl = document.getElementById('opToast');
        const toastMsg = document.getElementById('toast-msg');
        toastMsg.innerText = msg;
        toastEl.classList.remove('bg-success', 'bg-danger');
        toastEl.classList.add(isError ? 'bg-danger' : 'bg-success');
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();
    }

    // 导出配置
    async function exportConfig() {
        try {
            const response = await fetch('/api/config/export');
            const data = await response.json();
            const blob = new Blob([JSON.stringify(data, null, 4)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            a.href = url;
            a.download = `ipmi_config_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('配置导出成功');
        } catch (e) {
            showToast('导出失败: ' + e.message, true);
        }
    }

    // 打开导入 Modal
    function openImportModal() {
        if (!importModal) importModal = new bootstrap.Modal(document.getElementById('importModal'));
        document.getElementById('import-error-msg').classList.add('d-none');
        document.getElementById('config-upload').value = '';
        importModal.show();
    }

    let pendingImportConfig = null;

    // 导入预检
    async function handleImport(files) {
        if (files.length === 0) return;
        const errorEl = document.getElementById('import-error-msg');
        errorEl.classList.add('d-none');

        const file = files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const config = JSON.parse(e.target.result);
                pendingImportConfig = config;

                const res = await fetch('/api/config/precheck', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                // 显示元数据
                document.getElementById('import-version-val').innerText = data.version || '1';
                document.getElementById('import-time-val').innerText = data.export_time || '未知';
                document.getElementById('import-sw-val').innerText = data.software_version || '未知';

                renderImportDiff(data);
            } catch (err) {
                errorEl.innerText = '解析失败: ' + err.message;
                errorEl.classList.remove('d-none');
            }
        };
        reader.readAsText(file);
    }

    function renderImportDiff(data) {
        document.getElementById('import-precheck-view').classList.add('d-none');
        document.getElementById('import-diff-view').classList.remove('d-none');
        document.getElementById('import-modal-footer').classList.remove('d-none');

        const tbody = document.getElementById('import-diff-table');
        let html = '';

        // 渲染基础设置差异
        data.diffs.sort((a, b) => (b.changed - a.changed)).forEach(d => {
            const isChanged = d.changed;
            // 美化高亮：移除浅蓝色背景，改用柔和的 GitHub 风格变更提示
            html += `
                <tr class="${isChanged ? 'border-start border-4 border-success' : 'opacity-50'}" 
                    style="${isChanged ? 'background: rgba(63, 185, 80, 0.05);' : ''}">
                    <td class="ps-3"><input type="checkbox" class="import-item-check" data-type="setting" data-key="${d.key}" ${isChanged?'checked':''}></td>
                    <td class="fw-bold py-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-sliders-h me-2 text-muted" style="width: 16px;"></i>
                            <span>${d.key}</span>
                            ${!isChanged ? '<span class="badge bg-dark text-muted border border-secondary ms-2" style="font-size: 9px; padding: 2px 4px;">UNCHANGED</span>' : ''}
                        </div>
                    </td>
                    <td class="text-muted font-monospace small">
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${d.old.length > 30 ? d.old : ''}">
                            ${d.old}
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${isChanged ? `
                                <i class="fas fa-long-arrow-alt-right text-success mx-2"></i>
                                <span class="text-success-emphasis fw-bold font-monospace small bg-success bg-opacity-10 px-2 py-1 rounded">${d.new}</span>
                            ` : `
                                <span class="text-muted font-monospace small px-2">${d.new}</span>
                            `}
                        </div>
                    </td>
                </tr>
            `;
        });

        // 渲染告警规则差异 (参数级对比)
        data.alerts.sort((a, b) => (b.changed - a.changed)).forEach((a, idx) => {
            const isChanged = a.changed;
            let detailHtml = '';
            if (a.params_changed && a.params_changed.length > 0) {
                detailHtml = a.params_changed.map(p => `
                    <div class="mt-1 d-flex align-items-center gap-2" style="font-size: 11px;">
                        <span class="text-muted-plus">${p.field}:</span>
                        <span class="text-danger text-decoration-line-through opacity-75">${p.old}</span>
                        <i class="fas fa-caret-right text-muted small"></i>
                        <span class="text-success fw-bold">${p.new}</span>
                    </div>
                `).join('');
            }

            html += `
                <tr class="${isChanged ? 'border-start border-4 border-info' : 'opacity-50'}"
                    style="${isChanged ? 'background: rgba(56, 139, 253, 0.05);' : ''}">
                    <td class="ps-3"><input type="checkbox" class="import-item-check" data-type="alert" data-idx="${idx}" ${isChanged?'checked':''}></td>
                    <td class="py-3">
                        <div class="fw-bold d-flex align-items-center">
                            <i class="fas fa-bell me-2 text-warning" style="width: 16px;"></i>
                            ${a.name}
                        </div>
                        ${detailHtml}
                    </td>
                    <td class="text-muted small">指标: ${a.data.metric}</td>
                    <td>
                        ${isChanged ? `
                            <span class="badge rounded-pill ${a.is_new ? 'bg-success' : 'bg-info'}" style="font-size: 10px;">
                                ${a.is_new ? 'NEW RULE' : 'UPDATE'}
                            </span>
                        ` : `
                            <span class="badge border border-secondary text-muted rounded-pill" style="font-size: 10px;">NO CHANGE</span>
                        `}
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    function toggleImportSelectAll(checked) {
        document.querySelectorAll('.import-item-check').forEach(el => el.checked = checked);
    }

    async function executeImport() {
        if (!pendingImportConfig) return;
        
        const selectedSettings = {};
        const selectedAlerts = [];
        
        document.querySelectorAll('.import-item-check:checked').forEach(el => {
            if (el.dataset.type === 'setting') {
                selectedSettings[el.dataset.key] = pendingImportConfig.settings[el.dataset.key];
            } else {
                selectedAlerts.push(pendingImportConfig.alert_rules[el.dataset.idx]);
            }
        });

        try {
            const res = await fetch('/api/config/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    settings: selectedSettings,
                    alert_rules: selectedAlerts
                })
            });
            const result = await res.json();
            if (result.status === 'success') {
                showToast('导入成功');
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error(result.error || '导入失败');
            }
        } catch (e) {
            showToast(e.message, true);
        }
    }

    function parseUAInfo(ua) {
        let tag = "Unknown";
        if (ua.includes("HuaweiBrowser") || ua.includes("ArkWeb")) tag = "Huawei";
        else if (ua.includes("Edg/")) tag = "Edge";
        else if (ua.includes("Chrome")) tag = "Chrome";
        else if (ua.includes("Firefox")) tag = "Firefox";
        else if (ua.includes("Safari") && !ua.includes("Chrome")) tag = "Safari";
        else if (ua.toLowerCase().includes("python")) tag = "Python";
        else if (ua.toLowerCase().includes("curl")) tag = "cURL";
        return tag;
    }

    // 生成指纹 ID
    function getFingerprintId(ip, ua) {
        const str = `${ip}_${ua}`;
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return 'fp_' + Math.abs(hash).toString(16);
    }

    // 高亮同指纹的所有标签
    function highlightFingerprint(fingerprintId, event) {
        event.stopPropagation();
        document.querySelectorAll('.cli-tag').forEach(el => {
            el.classList.remove('highlighted');
        });
        document.querySelectorAll(`[data-fingerprint="${fingerprintId}"]`).forEach(el => {
            el.classList.add('highlighted');
        });
        setTimeout(() => {
            document.querySelectorAll('.cli-tag').forEach(el => {
                el.classList.remove('highlighted');
            });
        }, 3000);
    }

    // 切换折叠
    function toggleDetails(id) {
        const el = document.getElementById(id);
        el.classList.toggle('show');
    }

    let lastTimestamp = 0;
    let isFirstLoad = true;

    function renderLogLine(log, idx) {
        const fingerprintId = getFingerprintId(log.operator, log.ua);
        const uaTag = parseUAInfo(log.ua);
        
        // 统一状态配置 - 所有状态使用等宽长度 [XXXX] 格式
        const isSuccess = log.action === 'LOGIN_SUCCESS';
        const isFail = log.action === 'LOGIN_FAIL' || log.level === 'SECURITY' || log.level === 'ERROR';
        
        let statusClass = 'info';
        let statusText = '[INFO]';
        
        if (isSuccess) {
            statusClass = 'success';
            statusText = '[ OK ]';
        } else if (isFail) {
            statusClass = 'fail';
            statusText = '[FAIL]';
        } else if (log.level === 'WARN') {
            statusClass = 'warn';
            statusText = '[WARN]';
        }
        
        const detailsId = `detail-${log.timestamp}-${idx}`;
        
        // 统一消息格式：只显示次数和罚时，不重复显示 message 中的内容
        let mainMsg = log.message;
        if (log.module === 'AUTH' && log.details && log.details.fail_count !== undefined) {
            const count = log.details.fail_count;
            const wait = log.details.wait_time || 0;
            // 直接用次数和罚时格式
            mainMsg = `登录失败 (次数: ${count}，罚时: ${wait}s)`;
        }
        
        // 详情内容
        let detailsContent = '';
        if (log.details && Object.keys(log.details).length > 0) {
            detailsContent = JSON.stringify(log.details, null, 2);
        }
        if (log.ua) {
            detailsContent += (detailsContent ? '\n' : '') + `User-Agent: ${log.ua}`;
        }
        
        return `
            <div class="cli-line fingerprint-group">
                <span class="cli-time">${log.time_str}</span>
                <span class="cli-status ${statusClass}">${statusText}</span>
                <div class="cli-content">
                    <span class="cli-tag cli-tag-ip" 
                          data-fingerprint="${fingerprintId}"
                          onclick="highlightFingerprint('${fingerprintId}', event)"
                          title="点击高亮相同指纹">${log.operator}</span>
                    <span class="cli-tag cli-tag-ua" 
                          data-fingerprint="${fingerprintId}"
                          onclick="highlightFingerprint('${fingerprintId}', event)"
                          title="点击高亮相同指纹">${uaTag}</span>
                    <span class="fw-bold">${log.module}</span>
                    <span class="text-muted">${mainMsg}</span>
                    ${detailsContent ? `
                        <a href="javascript:void(0)" class="text-primary ms-2" onclick="toggleDetails('${detailsId}')">
                            [详情]
                        </a>
                    ` : ''}
                </div>
            </div>
            ${detailsContent ? `
                <div class="cli-details collapse" id="${detailsId}">
                    <div class="cli-details-title">
                        <i class="fas fa-info-circle me-1"></i> 详细信息
                    </div>
                    <pre>${detailsContent}</pre>
                </div>
            ` : ''}
        `;
    }

    async function loadLogs() {
        const container = document.getElementById('logs-container');

        try {
            const response = await fetch('/api/audit_logs?limit=500');
            const data = await response.json();
            
            if (!data.logs || data.logs.length === 0) {
                if (isFirstLoad) {
                    container.innerHTML = '<div class="text-center py-5 text-muted">暂无日志记录</div>';
                    isFirstLoad = false;
                }
                return;
            }

            // 按时间倒序
            const sortedLogs = data.logs.sort((a, b) => b.timestamp - a.timestamp);
            
            // 首次加载
            if (isFirstLoad) {
                let html = '';
                sortedLogs.forEach((log, idx) => {
                    html += renderLogLine(log, idx);
                });
                container.innerHTML = html;
                lastTimestamp = sortedLogs[0]?.timestamp || 0;
                isFirstLoad = false;
                return;
            }

            // 增量更新：只添加新日志
            const newLogs = sortedLogs.filter(log => log.timestamp > lastTimestamp);
            if (newLogs.length > 0) {
                let html = '';
                newLogs.sort((a, b) => b.timestamp - a.timestamp).forEach((log, idx) => {
                    html += renderLogLine(log, idx);
                });
                // 插入到容器开头
                container.insertAdjacentHTML('afterbegin', html);
                lastTimestamp = sortedLogs[0].timestamp;
            }
            
        } catch (e) {
            if (isFirstLoad) {
                container.innerHTML = `<div class="alert alert-danger">加载失败: ${e.message}</div>`;
                isFirstLoad = false;
            }
        }
    }

    // --- 综合设置中心逻辑 ---
    let settingsModal;
    let confirmModal;
    let globalSettings = {};
    let alertRules = [];
    let dbSizeTimer = null;

    // 实时更新数据库体积
    async function refreshDbSize() {
        try {
            const res = await fetch('/api/settings');
            const data = await res.json();
            const formatBytes = (bytes) => {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };
            const el = document.getElementById('db-size-val');
            if (el) el.innerText = formatBytes(data.db_size_bytes || 0);
        } catch (e) {}
    }

    function showConfirmModal(msg, onConfirm) {
        if (!confirmModal) confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        document.getElementById('confirm-msg').innerText = msg;
        const btn = document.getElementById('confirm-execute-btn');
        btn.onclick = () => {
            onConfirm();
            confirmModal.hide();
        };
        confirmModal.show();
    }

    const DASHBOARD_PRESETS = [1, 2, 3, 6, 12, 24, 48, 72, 168, 336, 720];

    async function openDelaySettings() {
        if (!settingsModal) settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
        
        try {
            // 1. 获取全局设置
            const res = await fetch('/api/settings');
            globalSettings = await res.json();
            
            // 填充 UI
            document.getElementById('set-warn').value = globalSettings.log_delay_warn;
            document.getElementById('set-danger').value = globalSettings.log_delay_danger;
            document.getElementById('set-retention').value = globalSettings.data_retention_days;
            
            // 显示数据库体积
            const formatBytes = (bytes) => {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };
            document.getElementById('db-size-val').innerText = formatBytes(globalSettings.db_size_bytes || 0);

            // 动态渲染勾选框 (优化视觉：激活状态使用 primary)
            const renderChecks = (containerId, currentArr) => {
                const container = document.getElementById(containerId);
                container.innerHTML = DASHBOARD_PRESETS.map(h => {
                    const label = h > 24 ? (h/24).toFixed(0) + 'D' : h + 'H';
                    const checked = currentArr.includes(h) ? 'checked' : '';
                    return `
                        <div class="form-check form-check-inline m-0">
                            <input class="btn-check" type="checkbox" id="${containerId}-${h}" value="${h}" ${checked}>
                            <label class="btn btn-outline-primary btn-sm px-3" for="${containerId}-${h}">${label}</label>
                        </div>
                    `;
                }).join('');
            };
            renderChecks('check-hw-hours', globalSettings.dashboard_hours_hw);
            renderChecks('check-hist-hours', globalSettings.dashboard_hours_hist);
            
            // 处理保留期状态
            const statusEl = document.getElementById('retention-status');
            if (globalSettings.retention_change_ts > 0) {
                const elapsed = (Date.now() / 1000) - globalSettings.retention_change_ts;
                const remaining = Math.max(0, 3 * 24 - (elapsed / 3600)).toFixed(1);
                statusEl.innerHTML = `<span class="badge bg-warning text-dark">待处理: ${globalSettings.pending_retention_days} 天 (剩余约 ${remaining} 小时生效)</span>`;
            } else {
                statusEl.innerHTML = `<span class="badge bg-success">当前已生效</span>`;
            }

            // 2. 获取告警规则
            await loadAlertRules();
            
            settingsModal.show();
        } catch (e) {
            showToast('加载设置失败: ' + e.message, true);
        }
    }

    async function loadAlertRules() {
        const res = await fetch('/api/alert_rules');
        alertRules = await res.json();
        renderAlertRules();
    }

    function renderAlertRules() {
        const container = document.getElementById('alert-rules-container');
        if (alertRules.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted small">暂无告警规则</div>';
            return;
        }

        container.innerHTML = alertRules.map((rule, idx) => {
            const isDeleted = rule._deleted === true;
            return `
            <div class="card rule-card fade-in-up ${isDeleted ? 'opacity-50' : ''}" style="${isDeleted ? 'border-style: dashed;' : ''}">
                <div class="card-body p-2 px-3">
                    <div class="d-flex align-items-center gap-2">
                        ${!isDeleted ? `
                        <div class="form-check form-switch me-1">
                            <input class="form-check-input" type="checkbox" ${rule.enabled ? 'checked' : ''} 
                                   onchange="updateRuleLocalByIndex(${idx}, 'enabled', this.checked ? 1 : 0)">
                        </div>
                        ` : '<div class="me-1"></div>'}
                        
                        <input type="text" class="form-control form-control-sm bg-transparent border-0 ${isDeleted ? 'text-muted text-decoration-line-through' : 'text-primary'} fw-bold p-0 flex-grow-1" 
                               value="${rule.name}" onchange="updateRuleLocalByIndex(${idx}, 'name', this.value)" style="min-width:80px;" ${isDeleted ? 'readonly' : ''}>
                        
                        <div class="d-flex align-items-center gap-1 small text-muted-plus">
                            ${!isDeleted ? `
                            <!-- 等级选择 -->
                            <select class="form-select form-select-sm bg-dark border-secondary text-light py-0 px-1" style="width:65px; height:24px; font-size:10px;"
                                       onchange="updateRuleLocalByIndex(${idx}, 'level', this.value)">
                                <option value="WARN" ${rule.level==='WARN'?'selected':''}>WARN</option>
                                <option value="INFO" ${rule.level==='INFO'?'selected':''}>INFO</option>
                            </select>

                            <select class="form-select form-select-sm bg-dark border-secondary text-light py-0 px-1" style="width:90px; height:24px; font-size:11px;"
                                       onchange="updateRuleLocalByIndex(${idx}, 'metric', this.value)">
                                <option value="cpu_temp" ${rule.metric==='cpu_temp'?'selected':''}>CPU温度</option>
                                <option value="fan_rpm" ${rule.metric==='fan_rpm'?'selected':''}>风扇转速</option>
                                <option value="power" ${rule.metric==='power'?'selected':''}>功耗</option>
                                <option value="cpu_usage" ${rule.metric==='cpu_usage'?'selected':''}>CPU负载</option>
                                <option value="mem_usage" ${rule.metric==='mem_usage'?'selected':''}>内存占用</option>
                                <option value="gpu_temp" ${rule.metric==='gpu_temp'?'selected':''}>GPU温度</option>
                                <option value="gpu_util" ${rule.metric==='gpu_util'?'selected':''}>GPU负载</option>
                                <option value="gpu_mem" ${rule.metric==='gpu_mem'?'selected':''}>显存占用</option>
                            </select>
                            <select class="form-select form-select-sm bg-dark border-secondary text-light py-0 px-1" style="width:50px; height:24px; font-size:11px;"
                                       onchange="updateRuleLocalByIndex(${idx}, 'operator', this.value)">
                                <option value=">" ${rule.operator==='>'?'selected':''}>></option>
                                <option value="<" ${rule.operator==='<'?'selected':''}><</option>
                                <option value=">=" ${rule.operator==='>='?'selected':''}>&ge;</option>
                            </select>
                            <input type="number" class="form-control form-control-sm bg-dark border-secondary text-light py-0 px-1" style="width:50px; height:24px; font-size:11px;"
                                       value="${rule.threshold}" onchange="updateRuleLocalByIndex(${idx}, 'threshold', parseFloat(this.value))">
                            ` : ''}
                        </div>

                        <div class="vr mx-1" style="height:15px; opacity:0.2;"></div>

                        ${!isDeleted ? `
                        <div class="d-flex align-items-center gap-1 small text-muted" title="持续时间 / 通知频率">
                            <i class="fas fa-clock" style="font-size:10px;"></i>
                            <input type="number" class="form-control form-control-sm bg-dark border-secondary text-light py-0 px-1" style="width:40px; height:24px; font-size:11px;"
                                                     value="${rule.duration}" onchange="updateRuleLocalByIndex(${idx}, 'duration', parseInt(this.value))">
                            <span>/</span>
                            <input type="number" class="form-control form-control-sm bg-dark border-secondary text-light py-0 px-1" style="width:50px; height:24px; font-size:11px;"
                                                       value="${rule.notify_interval}" onchange="updateRuleLocalByIndex(${idx}, 'notify_interval', parseInt(this.value))">
                        </div>
                        ` : '<span class="badge bg-danger ms-2">待删除</span>'}

                        ${!isDeleted ? `
                        <button class="btn btn-link btn-sm text-danger p-0 ms-2" onclick="markDeleteRuleByIndex(${idx})" title="标记删除 (保存后生效)">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        ` : `
                        <button class="btn btn-link btn-sm text-success p-0 ms-2" onclick="undoDeleteRuleByIndex(${idx})" title="撤销删除">
                            <i class="fas fa-undo"></i>
                        </button>
                        `}
                    </div>
                </div>
            </div>
        `}).join('');
    }

    function updateRuleLocalByIndex(idx, field, value) {
        if (alertRules[idx]) alertRules[idx][field] = value;
    }

    // 同步 UI 上的所有输入到内存变量
    function syncAllRulesFromUI() {
        const container = document.getElementById('alert-rules-container');
        if (!container) return;
        
        const cards = container.querySelectorAll('.rule-card');
        cards.forEach((card, idx) => {
            const rule = alertRules[idx];
            if (!rule || rule._deleted) return;

            const nameInput = card.querySelector('input[type="text"]');
            const levelSelect = card.querySelector('select[onchange*="\'level\'"]');
            const metricSelect = card.querySelector('select[onchange*="\'metric\'"]');
            const opSelect = card.querySelector('select[onchange*="\'operator\'"]');
            const thresholdInput = card.querySelector('input[type="number"][onchange*="\'threshold\'"]');
            const durationInput = card.querySelector('input[type="number"][onchange*="\'duration\'"]');
            const notifyInput = card.querySelector('input[type="number"][onchange*="\'notify_interval\'"]');
            const enabledCheck = card.querySelector('.form-check-input');

            if (nameInput) rule.name = nameInput.value;
            if (levelSelect) rule.level = levelSelect.value;
            if (metricSelect) rule.metric = metricSelect.value;
            if (opSelect) rule.operator = opSelect.value;
            if (thresholdInput) rule.threshold = parseFloat(thresholdInput.value);
            if (durationInput) rule.duration = parseInt(durationInput.value);
            if (notifyInput) rule.notify_interval = parseInt(notifyInput.value);
            if (enabledCheck) rule.enabled = enabledCheck.checked ? 1 : 0;
        });
    }

    function addNewAlertRule() {
        // 先同步当前所有正在编辑的内容
        syncAllRulesFromUI();
        
        // 仅在前端 Push 暂存，不发起后端请求
        const newRule = { name: "新规则", metric: "cpu_temp", operator: ">", threshold: 80, duration: 30, notify_interval: 600, level: "WARN", enabled: 1 };
        alertRules.push(newRule);
        renderAlertRules();
    }

    // 标记删除规则（前端本地标记，保存时生效）
    function markDeleteRuleByIndex(idx) {
        if (alertRules[idx]) {
            alertRules[idx]._deleted = true;
            renderAlertRules();
        }
    }

    // 撤销删除规则
    function undoDeleteRuleByIndex(idx) {
        if (alertRules[idx]) {
            delete alertRules[idx]._deleted;
            renderAlertRules();
        }
    }

    // 旧版直接删除函数（保留但不再使用）
    async function deleteRule(id) {
        showConfirmModal('规则删除后将无法恢复，确定继续吗？', async () => {
            try {
                await fetch(`/api/alert_rules?id=${id}`, { method: 'DELETE' });
                await loadAlertRules();
                showToast('规则已删除');
            } catch (e) { showToast('删除失败', true); }
        });
    }

    async function saveGlobalSettings() {
        const btn = document.getElementById('btn-save-global');
        const text = document.getElementById('save-btn-text');
        const spinner = document.getElementById('save-btn-spinner');

        // 在保存前，务必先同步一次所有 UI 上的最新修改到 alertRules 数组
        syncAllRulesFromUI();

        const getChecked = (containerId) => {
            return Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(el => parseInt(el.value));
        };

        // 过滤掉被标记为删除的规则（不发送到后端）
        const rulesToSave = alertRules.filter(r => !r._deleted).map(r => {
            const { _deleted, ...cleanRule } = r; // 移除 _deleted 字段
            return cleanRule;
        });

        // 封装统一 payload，减少请求次数和数据库锁定时间
        const payload = {
            log_delay_warn: parseFloat(document.getElementById('set-warn').value),
            log_delay_danger: parseFloat(document.getElementById('set-danger').value),
            data_retention_days: parseInt(document.getElementById('set-retention').value),
            dashboard_hours_hw: getChecked('check-hw-hours'),
            dashboard_hours_hist: getChecked('check-hist-hours'),
            alert_rules: rulesToSave // 只发送未被标记删除的规则
        };

        try {
            btn.disabled = true;
            text.classList.add('d-none');
            spinner.classList.remove('d-none');

            // 一次性发送请求，提升性能并防止阻塞数据采集
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                showToast('系统设置已应用并保存成功');
                settingsModal.hide();
                delayConfig = { log_delay_warn: payload.log_delay_warn, log_delay_danger: payload.log_delay_danger };
                drawIntervalChart();
            }
        } catch (e) {
            showToast('保存失败: ' + e.message, true);
        } finally {
            btn.disabled = false;
            text.classList.remove('d-none');
            spinner.classList.add('d-none');
        }
    }

    // 定义全局变量以防报错
    let chartData = [];
    let delayConfig = { log_delay_warn: 1.5, log_delay_danger: 5.0 };
    let chartTooltip;

    // 优化后的绘制逻辑
    async function drawIntervalChart() {
        const canvas = document.getElementById('intervalCanvas');
        const wrapper = document.getElementById('chart-wrapper');
        if (!canvas || !wrapper) return;

        const maxMarker = document.getElementById('chart-max-val');
        const avgMarker = document.getElementById('chart-avg-val');
        const minMarker = document.getElementById('chart-min-val');
        const ctx = canvas.getContext('2d');

        // 初始化 tooltip
        if (!chartTooltip) {
            chartTooltip = document.getElementById('chart-tooltip');
        }

        // 颜色映射辅助函数
        const getColor = (val) => {
            const warn = parseFloat(delayConfig.log_delay_warn) || 1.5;
            const danger = parseFloat(delayConfig.log_delay_danger) || 5.0;
            if (val <= warn) return '#1a7f37'; 
            if (val <= danger) return '#d29922';
            return '#f85149';
        };

        try {
            wrapper.classList.add('chart-loading');

            // 1. 获取配置 (如果 DOMContentLoaded 里的请求还没回来，这里做个兜底)
            try {
                const configRes = await fetch('/api/log_delay_config');
                if (configRes.ok) {
                    const cfg = await configRes.json();
                    if (cfg && cfg.log_delay_warn) delayConfig = cfg;
                }
            } catch (e) { console.warn("Failed to load delay config", e); }

            // 2. 获取数据
            const response = await fetch('/api/recording_stats');
            if (!response.ok) throw new Error('API Response Error');
            const data = await response.json();
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (maxMarker) maxMarker.innerText = 'MAX: --';
                if (avgMarker) avgMarker.innerText = 'AVG: --';
                if (minMarker) minMarker.innerText = 'MIN: --';
                wrapper.classList.remove('chart-loading');
                return;
            }

            chartData = data;

            // 3. 数据归一化处理 (防止 NaN)
            const values = data.map(item => {
                const v = typeof item === 'object' ? item.v : item;
                return isNaN(parseFloat(v)) ? 0 : parseFloat(v);
            });

            if (values.length === 0) return;

            // 4. 数据统计
            const maxVal = Math.max(...values);
            const minVal = Math.min(...values);
            const avgVal = values.reduce((a, b) => a + b, 0) / values.length;
            
            // 更新标注
            maxMarker.innerText = `MAX: ${maxVal.toFixed(1)}s`;
            maxMarker.style.color = getColor(maxVal);
            
            avgMarker.innerText = `AVG: ${avgVal.toFixed(1)}s`;
            avgMarker.style.color = getColor(avgVal);
            
            minMarker.innerText = `MIN: ${minVal.toFixed(1)}s`;
            minMarker.style.color = getColor(minVal);

            // 高清 Canvas 处理
            const dpr = window.devicePixelRatio || 1;
            const rect = wrapper.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;
            const barWidth = width / data.length;

            ctx.clearRect(0, 0, width, height);
            
            // 算法优化：平方根缩放 + 预留顶部 30% 空间给标注区
            // 确保在数值很小时，3s 位于中间高度 (50%)
            // 3s 的平方根是 1.732，如果要在 50% 高度显示，则逻辑上的最大值平方根应为 1.732 * 2 = 3.464
            // 对应的逻辑最大值约为 12s
            const scaledMax = Math.max(Math.sqrt(maxVal), Math.sqrt(3) * 2);
            const usableHeight = height * 0.7; 

            data.forEach((item, i) => {
                const val = typeof item === 'object' ? item.v : item;
                ctx.fillStyle = getColor(val);

                const scaledVal = Math.sqrt(val);
                let barHeight = (scaledVal / scaledMax) * usableHeight;
                
                // 极小值也保持 2px 可见度，确保在大屏幕上也能看清
                barHeight = Math.max(2, barHeight);
                
                // 绘制柱状图
                const x = i * barWidth;
                ctx.fillRect(x, height - barHeight, barWidth + 0.5, barHeight);
            });

        } catch (e) {
            console.error("Chart Render Error:", e);
        } finally {
            // 无论成功失败，强制移除加载状态
            wrapper.classList.remove('chart-loading');
        }
    }

    // Chart 鼠标事件处理（移动端禁用）
    function initChartEvents() {
        const canvas = document.getElementById('intervalCanvas');
        
        // 移动端检测
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                       || window.innerWidth <= 768;
        
        if (isMobile) return;

        // 鼠标移动 - 使用 offsetX/offsetY 获取相对于 canvas 的坐标
        canvas.addEventListener('mousemove', (e) => {
            if (chartData.length === 0) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.offsetX;
            const barWidth = rect.width / chartData.length;
            const index = Math.floor(x / barWidth);

            if (index >= 0 && index < chartData.length) {
                const item = chartData[index];
                const val = typeof item === 'object' ? item.v : item;
                const ts = typeof item === 'object' ? item.t : null;
                
                const getColor = (v) => {
                    if (v <= delayConfig.log_delay_warn) return '#1a7f37'; // 进一步加深绿色
                    if (v <= delayConfig.log_delay_danger) return '#d29922'; // 黄色
                    return '#f85149';                 // 红色
                };

                // 计算时间点
                let timeStr;
                if (ts) {
                    timeStr = new Date(ts * 1000).toLocaleTimeString('zh-CN', { hour12: false });
                } else {
                    const now = new Date();
                    const targetTime = new Date(now.getTime() - (chartData.length - 1 - index) * (86400000 / chartData.length));
                    timeStr = targetTime.toLocaleTimeString('zh-CN', { hour12: false });
                }

                chartTooltip.innerHTML = `${timeStr} &bull; ${val.toFixed(2)}s`;
                chartTooltip.style.color = getColor(val);

                // 边界检测：确保 tooltip 不超出屏幕
                const tooltipWidth = chartTooltip.offsetWidth || 100;
                const tooltipHeight = chartTooltip.offsetHeight || 24;
                const padding = 15;

                let left = e.offsetX + 10;
                let top = e.offsetY - 25;

                // 右侧边界检测
                if (left + tooltipWidth + padding > window.innerWidth) {
                    left = e.offsetX - tooltipWidth - 10;
                }
                // 左侧边界检测
                if (left < padding) {
                    left = padding;
                }
                // 顶部边界检测
                if (top < padding) {
                    top = e.offsetY + 15;
                }
                // 底部边界检测
                if (top + tooltipHeight + padding > window.innerHeight) {
                    top = window.innerHeight - tooltipHeight - padding;
                }

                chartTooltip.style.left = `${left}px`;
                chartTooltip.style.top = `${top}px`;
                chartTooltip.classList.add('visible');
            }
        });

        // 鼠标离开
        canvas.addEventListener('mouseleave', () => {
            chartTooltip.classList.remove('visible');
        });
    }

    // 监听窗口大小变化重新绘制
    window.addEventListener('resize', () => {
        clearTimeout(window.resizeTimer);
        window.resizeTimer = setTimeout(drawIntervalChart, 200);
    });

    // 自动刷新
    function startAutoRefresh() {
        setInterval(() => {
            loadLogs();
        }, 3000); // 每3秒检查新日志
    }

    document.addEventListener('DOMContentLoaded', async () => {
        // 监听设置 Modal 事件
        const settingsModalEl = document.getElementById('settingsModal');
        if (settingsModalEl) {
            settingsModalEl.addEventListener('shown.bs.modal', () => {
                // 窗口打开时启动定时器，每 5 秒刷新一次数据库大小
                if (dbSizeTimer) clearInterval(dbSizeTimer);
                dbSizeTimer = setInterval(refreshDbSize, 5000);
            });
            settingsModalEl.addEventListener('hidden.bs.modal', () => {
                // 窗口关闭时清除定时器
                if (dbSizeTimer) {
                    clearInterval(dbSizeTimer);
                    dbSizeTimer = null;
                }
            });
        }

        // 监听导入 Modal 关闭事件，重置状态
        const impModalEl = document.getElementById('importModal');
        if (impModalEl) {
            impModalEl.addEventListener('hidden.bs.modal', () => {
                document.getElementById('import-precheck-view').classList.remove('d-none');
                document.getElementById('import-diff-view').classList.add('d-none');
                document.getElementById('import-modal-footer').classList.add('d-none');
                document.getElementById('import-error-msg').classList.add('d-none');
                document.getElementById('config-upload').value = '';
                pendingImportConfig = null;
            });
        }

        // 先获取一次配置，确保 drawIntervalChart 能拿到正确的颜色阈值
        try {
            const configRes = await fetch('/api/log_delay_config');
            delayConfig = await configRes.json();
        } catch (e) {}

        loadLogs();
        startAutoRefresh();
        drawIntervalChart();
        initChartEvents();
    });
</script>

<footer class="text-center w-100 mb-3 mt-auto" style="pointer-events: none; flex-shrink: 0;">
    <a href="https://github.com/stlin256/IPMI_WEB" target="_blank" class="text-muted text-decoration-none small opacity-50 hover-opacity-100 transition-all" style="pointer-events: auto;">
        <i class="fab fa-github me-1"></i>GitHub @stlin256
    </a>
</footer>
</body>
</html>
