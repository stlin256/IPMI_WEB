<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Login Logs - {{ server_name }} Ops</title>
   <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
   <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
   <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <style>
        :root { --bg-body: #0d1117; --bg-card: #161b22; --border-color: #30363d; --text-main: #e6edf3; --text-muted: #8b949e; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: "Segoe UI", sans-serif; padding-bottom: 60px; }
        .navbar { background-color: rgba(22, 27, 34, 0.95) !important; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; }
        .ua-box { font-size: 0.75rem; color: var(--text-muted); background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; word-break: break-all; margin-top: 8px; }
        .log-group { border-left: 3px solid #1f6feb; padding-left: 15px; margin-bottom: 25px; transition: transform 0.2s; }
        .log-group:hover { transform: translateX(5px); }
        .badge-ip { background-color: rgba(31, 111, 235, 0.15); color: #58a6ff; font-family: monospace; font-size: 1rem; }
        .badge-wait { background-color: rgba(248, 81, 73, 0.15); color: #f85149; }
        .badge-ua { background-color: rgba(35, 134, 54, 0.15); color: #3fb950; }
        .timeline-item { position: relative; padding-bottom: 10px; border-left: 1px solid var(--border-color); padding-left: 20px; margin-left: 10px; }
        .timeline-item::before { content: ""; position: absolute; left: -5px; top: 5px; width: 9px; height: 9px; background: #30363d; border-radius: 50%; }

        /* 按钮箭头翻转动画 */
        .btn-toggle-arrow i { transition: transform 0.3s ease; }
        .btn-toggle-arrow:not(.collapsed) i { transform: rotate(180deg); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/hardware">
            <i class="fas fa-shield-alt me-2 text-warning"></i> <span class="fw-bold fs-4">{{ server_name }}</span>
        </a>
        <div class="navbar-nav flex-row ms-auto">
            <a href="/hardware" class="btn btn-outline-secondary btn-sm me-2">返回面板</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-history me-2 text-primary"></i>登录失败审计日志</h3>
        <button class="btn btn-primary btn-sm" onclick="loadLogs()"><i class="fas fa-sync-alt me-1"></i>刷新</button>
    </div>

    <div id="logs-container">
        <div class="text-center py-5 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>正在解析日志记录...</p>
        </div>
    </div>
</div>

<script>
    function loadLogs() {
        fetch('/api/logs').then(r => r.json()).then(groups => {
            const container = document.getElementById('logs-container');
            if (groups.length === 0) {
                container.innerHTML = '<div class="card p-5 text-center text-muted">目前没有任何登录失败记录。系统很安全！</div>';
                return;
            }

            container.innerHTML = groups.map((g, idx) => `
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
                            <div class="d-flex align-items-center">
                                <span class="badge badge-ip border border-primary me-2">${g.ip}</span>
                                <span class="badge badge-ua small"><i class="fas fa-laptop me-1"></i>${g.ua_tag}</span>
                            </div>
                            <div class="text-end">
                                <span class="text-muted small">最后尝试：</span>
                                <span class="fw-bold text-light">${g.last_time}</span>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-3">
                                <div class="bg-dark p-2 rounded text-center border border-secondary">
                                    <div class="small text-muted">累计尝试</div>
                                    <div class="h5 mb-0 text-info fw-bold">${g.total_attempts}</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="bg-dark p-2 rounded text-center border border-secondary">
                                    <div class="small text-muted">当前惩罚时长</div>
                                    <div class="h5 mb-0 text-danger fw-bold">${g.max_wait}s</div>
                                </div>
                            </div>
                        </div>

                        <div class="ua-box">
                            <i class="fas fa-fingerprint me-1 text-info"></i> <strong>浏览器指纹 (UA):</strong><br>
                            ${g.ua}
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-dark btn-sm w-100 mb-2 text-muted btn-toggle-arrow collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#hist-${idx}">
                                查看详细时间轴 <i class="fas fa-chevron-down ms-1"></i>
                            </button>
                            <div class="collapse mt-3" id="hist-${idx}">
                                ${g.history.map(h => `
                                    <div class="timeline-item">
                                        <span class="small text-muted me-3">${h.time}</span>
                                        <span class="badge ${h.wait > 0 ? 'badge-wait' : 'bg-secondary'} small">惩罚: ${h.wait}s</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        });
    }

    loadLogs();
</script>
</body>
</html>
