<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hardware - R730XD Ops</title>
   <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
   <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
   <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
   <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    
    <style>
        :root { --bg-body: #0d1117; --bg-card: #161b22; --border-color: #30363d; --text-main: #e6edf3; --text-muted: #8b949e; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: "Segoe UI", sans-serif; padding-bottom: 60px; }
        .navbar { background-color: rgba(22, 27, 34, 0.95) !important; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .nav-link { color: var(--text-muted) !important; font-weight: 500; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { color: #fff !important; }
        
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .card-header { background-color: transparent; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 1rem; padding: 1rem; }
        
        .metric-box { padding: 1.5rem; text-align: center; position: relative; overflow: hidden; transition: transform 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .metric-box:hover { border-color: #58a6ff; transform: translateY(-2px); }
        .metric-value { font-family: 'SF Mono', Consolas, monospace; font-size: 2.8rem; font-weight: 700; letter-spacing: -1px; margin-bottom: 5px; }
        .metric-unit { font-size: 1rem; color: var(--text-muted); font-weight: normal; }
        .metric-icon { position: absolute; top: 15px; right: 15px; font-size: 3.5rem; opacity: 0.05; transform: rotate(-15deg); }
        
        .table-custom { font-size: 0.9rem; font-family: monospace; }
        .table-custom th { background-color: rgba(255,255,255,0.02); color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding: 12px; }
        .table-custom td { border-bottom: 1px solid var(--border-color); vertical-align: middle; padding: 10px 12px; }
        .scroll-container { max-height: 550px; overflow-y: auto; scrollbar-width: thin; }
        
        input[type=range] { touch-action: none; cursor: pointer; }
        
        /* 新增样式：处理禁用状态的视觉效果 */
        .fixed-control-group { transition: opacity 0.3s ease, filter 0.3s ease; }
        .fixed-control-group.disabled-visual { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; }
        /* 允许滑块本身在禁用状态下依然可见，这里我们通过JS控制input的disabled属性，样式辅助 */
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <i class="fas fa-server me-2 text-primary"></i> <span class="fw-bold fs-4">R730XD</span>
        </a>
        <div class="navbar-nav flex-row me-auto ms-4">
            <a class="nav-link active me-3" href="/hardware">HW</a>
            <a class="nav-link me-3" href="/resources">RES</a>
            <a class="nav-link" href="/history">HIST</a>
        </div>
        <a href="/logout" class="btn btn-outline-danger"><i class="fas fa-sign-out-alt"></i></a>
    </div>
</nav>

<div class="container-fluid mt-4 px-3 px-md-4">
    <div class="row g-3 mb-4">
        <!-- 顶部 4 个 Metric 卡片 -->
        <div class="col-6 col-md-3">
            <div class="card metric-box">
                <i class="fas fa-thermometer-half metric-icon text-primary"></i>
                <div class="text-uppercase small text-muted fw-bold mb-1">CPU Max Temp</div>
                <div class="metric-value text-primary"><span id="val-temp">--</span> <span class="metric-unit">°C</span></div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card metric-box">
                <i class="fas fa-bolt metric-icon text-warning"></i>
                <div class="text-uppercase small text-muted fw-bold mb-1">Power Draw</div>
                <div class="metric-value text-warning"><span id="val-power">--</span> <span class="metric-unit">W</span></div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card metric-box">
                <i class="fas fa-fan metric-icon text-success"></i>
                <div class="text-uppercase small text-muted fw-bold mb-1">Fan Speed</div>
                <div class="metric-value text-success"><span id="val-fan">--</span> <span class="metric-unit">RPM</span></div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 p-4 d-flex flex-column justify-content-center align-items-center text-center">
                <div class="text-uppercase small text-muted fw-bold mb-2">Fan Control Mode</div>
                <div id="mode-display" class="h3 fw-bold mb-3">--</div>
                <button id="btn-mode" class="btn w-100 fw-bold btn-outline-primary" onclick="toggleMode()">Switch Mode</button>
                <div id="fixed-mode-warning" class="text-warning small mt-2 d-none"><i class="fas fa-exclamation-triangle"></i> Disable Fixed Speed to switch</div>
            </div>
        </div>
    </div>

    <!-- 历史趋势图表 -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-history me-2"></i>24-Hour Trend</span>
            <div class="btn-group">
               <button class="btn btn-sm btn-outline-secondary active" onclick="updateChart('power', event)">Power</button>
               <button class="btn btn-sm btn-outline-secondary" onclick="updateChart('temp', event)">Temp</button>
               <button class="btn btn-sm btn-outline-secondary" onclick="updateChart('fan', event)">Fan</button>
            </div>
        </div>
        <div class="card-body p-3" style="height: 320px;">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="row g-4">
        <!-- 传感器列表 -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-list-ul me-2"></i>Sensors List</span>
                    <span class="badge bg-secondary" id="sensor-count">0</span>
                </div>
                <div class="card-body p-0 scroll-container">
                    <table class="table table-dark table-striped table-hover table-custom mb-0">
                        <thead class="sticky-top bg-dark"><tr><th>SOURCE</th><th>NAME</th><th class="text-end">VALUE</th><th class="text-center hide-mobile">STATUS</th></tr></thead>
                        <tbody id="sensor-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 风扇控制区域 (修改部分) -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header"><i class="fas fa-sliders-h me-2"></i>Fan Configuration</div>
                <div class="card-body d-flex flex-column py-3 px-4">
                    
                    <!-- 原有的曲线设置入口 -->
                    <div class="flex-grow-1 w-100 mb-2" style="min-height: 120px;">
                        <canvas id="miniCurveChart"></canvas>
                    </div>
                    <button class="btn btn-primary w-100 mb-2 py-2" onclick="openCurveModal()">
                        <i class="fas fa-edit me-1"></i> Edit Fan Curve
                    </button>
                    <div class="text-muted small text-center mb-3" id="calibration-info">
                        Calibrated Range: <span id="rpm-range-display" class="text-info font-monospace fw-bold">--</span>
                    </div>

                    <!-- 新增：固定转速控制区域 -->
                    <div class="border-top border-secondary pt-3 mt-1">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="fixedFanSwitch" class="form-check-label fw-bold text-light">
                                <i class="fas fa-thumbtack me-2 text-warning"></i> Fixed Fan Speed
                            </label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="fixedFanSwitch" 
                                       style="transform: scale(1.4); cursor: pointer;" onchange="toggleFixedSwitch(this)">
                            </div>
                        </div>

                        <!-- 滑块和数值区域 -->
                        <div id="fixed-controls-wrapper" class="fixed-control-group disabled-visual">
                            <div class="d-flex align-items-center mt-3">
                                <input type="range" class="form-range flex-grow-1" min="10" max="100" id="fixedFanSlider" 
                                       oninput="handleFixedSliderInput(this.value)" 
                                       onchange="handleFixedSliderChange(this.value)" disabled>
                            </div>
                            <div class="d-flex justify-content-between text-center mt-2 bg-dark rounded p-2 border border-secondary">
                                <div class="w-50 border-end border-secondary">
                                    <div id="fixedFanValuePct" class="font-monospace text-info fw-bold fs-5">--%</div>
                                    <div class="text-muted small" style="font-size: 0.75rem;">TARGET</div>
                                </div>
                                <div class="w-50">
                                    <div id="fixedFanValueRpm" class="font-monospace text-success fw-bold fs-5">--</div>
                                    <div class="text-muted small" style="font-size: 0.75rem;">EST. RPM</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 结束新增区域 -->

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal 保持不变 -->
<div class="modal fade" id="curveModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background-color: #1c2128; border: 1px solid #444;">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">Manual Fan Curve (Target RPM %)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-end mb-3">
                    <button class="btn btn-sm btn-outline-warning" onclick="startCalibration()">
                        <i class="fas fa-tachometer-alt me-1"></i> Run Calibration
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-7 mb-3"><canvas id="curvePreviewChart" height="220"></canvas></div>
                    <div class="col-md-5" style="max-height: 300px; overflow-y: auto;">
                        <form id="curveForm"></form>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="saveCurve()">Save & Apply</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="calibModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-warning">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-warning"><i class="fas fa-cog fa-spin me-2"></i>Calibrating Fans...</h5>
            </div>
            <div class="modal-body text-center pt-2">
                <div class="my-4">
                    <div class="text-uppercase small text-muted mb-1">Current Speed</div>
                    <div style="font-family: 'SF Mono', Consolas, monospace; font-size: 3.5rem; font-weight: 700; color: #fff;">
                        <span id="calib-realtime-rpm">---</span> <span style="font-size: 1rem; color: #8b949e">RPM</span>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 6px; background: #30363d;">
                    <div id="calib-progress" class="progress-bar bg-warning" style="width: 0%"></div>
                </div>
                <div id="calib-log" class="font-monospace small text-white-50">Initializing...</div>
            </div>
        </div>
    </div>
</div>

<script>
    let mainChart, curveChart, miniCurveChart;
    let historyData = {}, currentCurve = {};
    let maxRPM = 0, minRPM = 0;
    
    // 状态标记，防止滑块拖动时被后台数据覆盖
    let isDraggingFixedSlider = false;

    const commonChartOptions = {
        responsive: true, maintainAspectRatio: false, animation: false,
        interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false } },
        scales: { x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', maxTicksLimit: 8 } }, y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } } },
        elements: { point: { radius: 0, hitRadius: 10 } }
    };

    function init() {
        mainChart = new Chart(document.getElementById('mainChart'), { type: 'line', data: { labels: [], datasets: [] }, options: commonChartOptions });
        
        miniCurveChart = new Chart(document.getElementById('miniCurveChart'), {
            type: 'line', data: { labels: [], datasets: [] }, 
            options: { 
                responsive: true, maintainAspectRatio: false, animation: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: { x: { display: false }, y: { display: false, min: 0, max: 100 } },
                elements: { point: { radius: 0 }, line: { borderWidth: 2, borderColor: '#1f6feb', tension: 0.3 } }
            }
        });

        // 初始化加载顺序
        loadInitialConfig(); 
        refreshData(); 
        loadHistory(); 
        
        setInterval(refreshData, 1000); 
        setInterval(loadHistory, 20000);
    }
    
    // --- 新增功能逻辑 Start ---

    // 1. 页面加载时获取一次完整配置，设置UI初值
    function loadInitialConfig() {
        fetch('/api/config').then(r => r.json()).then(d => {
            if(!d) return;
            
            // 曲线预览
            if(d.curve) {
                const labels = Object.keys(d.curve).sort((a,b)=>a-b);
                const data = labels.map(k=>d.curve[k]);
                miniCurveChart.data.labels = labels;
                miniCurveChart.data.datasets = [{data: data, borderColor: '#1f6feb', borderWidth: 2, fill: true, backgroundColor: 'rgba(31, 111, 235, 0.2)', tension: 0.3}];
                miniCurveChart.update();
            }

            // Fixed Fan Speed 初始化
            const isFixed = d.fixed_fan_speed_enabled === true || d.fixed_fan_speed_enabled === 'true';
            const target = d.fixed_fan_speed_target || 30;

            document.getElementById('fixedFanSwitch').checked = isFixed;
            const slider = document.getElementById('fixedFanSlider');
            slider.value = target;
            
            // 手动调用一次更新UI状态（设置禁用/启用样式）和数值
            updateFixedUIState(isFixed);
            updateFixedValuesDisplay(target);
        });
    }

    // 2. 切换开关
    function toggleFixedSwitch(el) {
        const isEnabled = el.checked;
        updateFixedUIState(isEnabled); // 立即更新UI视觉
        
        // 发送请求，成功后立刻刷新数据，防止UI跳变
        fetch('/api/config/fixed_fan_speed', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ enabled: isEnabled })
        }).then(() => {
            refreshData(); // <--- 关键修改：立刻强制刷新
        });
    }

    // 3. 滑块拖动中 (oninput) - 只更新显示，不发请求
    function handleFixedSliderInput(val) {
        isDraggingFixedSlider = true;
        updateFixedValuesDisplay(val);
    }

    // 4. 滑块松开 (onchange) - 发送请求
    function handleFixedSliderChange(val) {
        isDraggingFixedSlider = false;
        fetch('/api/config/fixed_fan_speed', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ target: parseInt(val) })
        }).then(() => {
            refreshData(); // <--- 关键修改：立刻强制刷新
        });
    }

    // 辅助：更新禁用/启用视觉状态
    function updateFixedUIState(enabled) {
        const wrapper = document.getElementById('fixed-controls-wrapper');
        const slider = document.getElementById('fixedFanSlider');
        
        if (enabled) {
            wrapper.classList.remove('disabled-visual');
            slider.disabled = false;
        } else {
            wrapper.classList.add('disabled-visual');
            slider.disabled = true;
        }
    }

    // 辅助：更新百分比和 RPM 显示
    function updateFixedValuesDisplay(pct) {
        document.getElementById('fixedFanValuePct').innerText = pct + '%';
        // 计算 RPM
        const estRpm = maxRPM > 0 ? Math.round(maxRPM * (pct/100)) : '--';
        document.getElementById('fixedFanValueRpm').innerText = estRpm;
    }

    // --- 新增功能逻辑 End ---

    function refreshData() {
        fetch('/api/status_hardware').then(r => r.json()).then(d => {
            if(!d || !d.sensors) return;
            document.getElementById('val-temp').innerText = d.temp;
            document.getElementById('val-power').innerText = d.power;
            document.getElementById('val-fan').innerText = d.fan_rpm;
            
            // 更新全局 RPM 数据
            maxRPM = d.max_rpm || 0;
            minRPM = d.min_rpm || 0;
            const rangeText = (maxRPM > 0) ? `${minRPM} - ${maxRPM} RPM` : "Not Calibrated";
            document.getElementById('rpm-range-display').innerText = rangeText;

            // 如果滑块未被拖动，更新固定模式区域的估算 RPM（因为 maxRPM 可能变化）
            if (!isDraggingFixedSlider) {
                const currentSliderVal = document.getElementById('fixedFanSlider').value;
                updateFixedValuesDisplay(currentSliderVal);
            }

            // 处理模式显示
            const modeText = document.getElementById('mode-display');
            const btn = document.getElementById('btn-mode');
            const warnMsg = document.getElementById('fixed-mode-warning');

            if (d.mode === 'fixed') {
                // 固定模式：优先级最高
                modeText.innerText = 'FIXED SPEED';
                modeText.className = 'h3 fw-bold mb-3 text-warning';
                
                // 禁用切换 Auto/Manual 的按钮
                btn.className = 'btn w-100 py-2 fw-bold btn-secondary disabled';
                btn.innerHTML = '<i class="fas fa-ban me-2"></i>Mode Locked';
                warnMsg.classList.remove('d-none');
                
                // 确保 UI 开关是开着的 (同步多端状态)
                const switchEl = document.getElementById('fixedFanSwitch');
                // 只有当用户没有正在操作的时候才覆盖
                // (这里简化处理，后端权威状态回来后更新UI是合理的)
                if (!switchEl.checked) {
                    switchEl.checked = true;
                    updateFixedUIState(true);
                }
                
            } else {
                // 正常 Auto/Manual 模式
                const isAuto = d.mode === 'auto';
                modeText.innerText = isAuto ? 'AUTOMATIC' : 'MANUAL';
                modeText.className = `h3 fw-bold mb-3 ${isAuto ? 'text-success' : 'text-primary'}`;
                
                btn.className = `btn w-100 py-2 fw-bold ${isAuto ? 'btn-outline-success' : 'btn-outline-primary'}`;
                btn.innerHTML = isAuto ? '<i class="fas fa-hand-paper me-2"></i>Switch to Manual' : '<i class="fas fa-robot me-2"></i>Switch to Auto';
                btn.onclick = toggleMode; // 恢复点击事件
                warnMsg.classList.add('d-none');

                // 确保 UI 开关是关着的
                const switchEl = document.getElementById('fixedFanSwitch');
                if (switchEl.checked) {
                    switchEl.checked = false;
                    updateFixedUIState(false);
                }
            }

            // 传感器列表渲染
            const tbody = document.getElementById('sensor-list');
            const html = d.sensors.map(s => {
                const statusColor = s.status === 'ok' ? 'text-success' : 'text-warning';
                return `<tr>
                    <td class="text-muted small">${s.source}</td><td class="fw-bold text-light">${s.name}</td>
                    <td class="text-end font-monospace text-info">${s.value} <span class="text-muted small">${s.unit}</span></td>
                    <td class="text-center hide-mobile"><i class="fas fa-circle small ${statusColor}"></i> <span class="small text-muted">${s.status}</span></td>
                </tr>`;
            }).join('');
            if (tbody.innerHTML !== html) tbody.innerHTML = html;
            document.getElementById('sensor-count').innerText = d.sensors.length;
        }).catch(e => console.log('Fetch error:', e));
    }

    function loadHistory() {
       fetch('/api/history').then(r => r.json()).then(d => {
           historyData = d;
           if (mainChart.data.datasets.length === 0) {
               updateChart('power', null, true);
           } else {
               const currentType = mainChart.data.datasets[0]._type;
               updateChart(currentType, null, true);
           }
       });
    }

   function updateChart(type, event, silent = false) {
       if (!historyData.hw) return;
       let data, color, label;
       if (type === 'power') { data = historyData.hw.power; color = '#e3b341'; label = 'Power (W)'; }
       if (type === 'temp') { data = historyData.hw.temps; color = '#1f6feb'; label = 'Temp (°C)'; }
       if (type === 'fan') { data = historyData.hw.fans; color = '#2ea043'; label = 'Fan (RPM)'; }
       mainChart.data.labels = historyData.times;
       mainChart.data.datasets = [{
           label: label, data: data, borderColor: color, backgroundColor: color + '20', borderWidth: 2, fill: true, _type: type, tension: 0.3
       }];
       mainChart.update('none');
       
       if (!silent && event) {
           document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
           event.target.classList.add('active');
       }
   }

    // Modal 和曲线设置部分
    function openCurveModal() {
        fetch('/api/config').then(r => r.json()).then(d => {
            currentCurve = d.curve || {}; 
            const f = document.getElementById('curveForm');
            f.innerHTML = '';
            for (let t = 30; t <= 90; t += 5) {
                const pct = currentCurve[t]||20;
                const estRpm = maxRPM > 0 ? Math.round(maxRPM * (pct/100)) : '--';
                f.innerHTML += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between text-muted small">
                        <span>${t}°C</span>
                        <span id="rpm-${t}">~${estRpm} RPM</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <input type="range" class="form-range flex-grow-1 me-2" min="10" max="100" 
                               value="${pct}" oninput="updateCurvePreview(${t}, this.value)">
                        <span class="font-monospace text-info" style="width: 35px; text-align:right" id="val-${t}">${pct}</span>
                    </div>
                </div>`;
            }
            new bootstrap.Modal(document.getElementById('curveModal')).show();
            setTimeout(drawCurvePreview, 300);
        });
    }

    function updateCurvePreview(temp, val) {
        currentCurve[temp] = parseInt(val);
        document.getElementById(`val-${temp}`).innerText = val;
        const estRpm = maxRPM > 0 ? Math.round(maxRPM * (val/100)) : '--';
        const rpmSpan = document.getElementById(`rpm-${temp}`);
        if(rpmSpan) rpmSpan.innerText = `~${estRpm} RPM`;
        drawCurvePreview();
    }

    function drawCurvePreview() {
        const ctx = document.getElementById('curvePreviewChart');
        if (curveChart) curveChart.destroy();
        const labels = Object.keys(currentCurve).sort((a,b)=>a-b);
        curveChart = new Chart(ctx, {
            type: 'line', data: {
                labels: labels, datasets: [{ data: labels.map(k => currentCurve[k]), borderColor: '#1f6feb', borderWidth: 2, tension: 0.3 }]
            },
            options: { 
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const pct = context.parsed.y;
                                const rpm = maxRPM > 0 ? Math.round(maxRPM * (pct/100)) : 0;
                                return `${pct}% (~${rpm} RPM)`;
                            }
                        }
                    }
                }, 
                scales: { y: { min: 0, max: 100, grid: { color: '#333' } }, x: { grid: { color: '#333' } } } 
            }
        });
    }

    function saveCurve() {
        fetch('/api/config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ curve: currentCurve }) })
            .then(() => { 
                bootstrap.Modal.getInstance(document.getElementById('curveModal')).hide();
                loadInitialConfig();
                refreshData(); // <--- 关键修改：立刻强制刷新
            });
    }

    function toggleMode() {
        const modeText = document.getElementById('mode-display').innerText;
        if(modeText.includes('FIXED')) {
            alert("Please disable Fixed Fan Speed first.");
            return;
        }
        
        const newMode = modeText === 'AUTOMATIC' ? 'manual' : 'auto';
        if(confirm(`Confirm switch to ${newMode.toUpperCase()} mode?`)) {
            fetch('/api/config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mode: newMode }) })
            .then(refreshData); // 这里本来就有调用
        }
    }

    let calibInterval;
    function startCalibration() {
        if(!confirm("Calibration takes a few minutes. Fans will slow down then speed up. Continue?")) return;
        bootstrap.Modal.getInstance(document.getElementById('curveModal')).hide();
        const calibModal = new bootstrap.Modal(document.getElementById('calibModal'));
        calibModal.show();
        fetch('/api/calibration/start', {method: 'POST'}).then(r=>r.json()).then(d=>{
            if(d.status === 'started') {
                calibInterval = setInterval(checkCalibStatus, 1000);
            }
        });
    }

    function checkCalibStatus() {
        fetch('/api/calibration/status').then(r=>r.json()).then(d => {
            document.getElementById('calib-progress').style.width = d.progress + '%';
            document.getElementById('calib-log').innerText = d.log;
            document.getElementById('calib-realtime-rpm').innerText = d.current_rpm || '---';
            if(!d.active && d.progress >= 100) {
                clearInterval(calibInterval);
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('calibModal')).hide();
                    alert("Calibration Complete!");
                    refreshData();
                }, 1000);
            }
        });
    }

    init();
</script>
</body>
</html>