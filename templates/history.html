<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>History - {{ server_name }} Ops</title>
   <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
   <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
   <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <style>
        :root { --bg-body: #0d1117; --bg-card: #161b22; --border-color: #30363d; --text-main: #e6edf3; --text-muted: #8b949e; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: "Segoe UI", system-ui, sans-serif; padding-bottom: 60px; }
        .navbar { background-color: rgba(22, 27, 34, 0.95) !important; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .nav-link { color: var(--text-muted) !important; font-weight: 500; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { color: #fff !important; }

        @media (max-width: 576px) {
            .navbar-brand { font-size: 1.2rem !important; margin-right: 0.5rem !important; }
            .navbar-nav.me-auto { margin-left: 0.5rem !important; }
            .nav-link { font-size: 0.9rem !important; margin-right: 0.5rem !important; padding-left: 0.2rem !important; padding-right: 0.2rem !important; }
            .btn-outline-danger { padding: 0.25rem 0.5rem !important; font-size: 0.8rem !important; }
        }
        
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 8px 24px rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; }
        .card-header { background-color: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border-color); padding: 1.25rem; }
        
        .form-select { background-color: #21262d; border-color: #30363d; color: #c9d1d9; border-radius: 6px; padding: 0.4rem 0.8rem; }
        .form-select:focus { border-color: #58a6ff; box-shadow: none; }
        
        /* 横向滚动容器 */
        .scrollable-tabs-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding: 10px 0;
            gap: 10px;
            scrollbar-width: none; /* Firefox */
        }
        .scrollable-tabs-container::-webkit-scrollbar { display: none; }
        
        /* 胶囊样式优化 */
        .btn-check-custom + .btn { 
            border-color: #444c56; color: var(--text-muted); background: #21262d; 
            border-radius: 8px; padding: 0.5rem 1.25rem; font-size: 0.95rem; font-weight: 600;
            white-space: nowrap; transition: all 0.2s;
        }
        .btn-check-custom:hover + .btn { background: #30363d; color: #fff; border-color: #57606a; }

        /* 骨架屏动画 */
        .skeleton { background: linear-gradient(90deg, #161b22 25%, #21262d 50%, #161b22 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-text { height: 1.5rem; margin-bottom: 0.5rem; border-radius: 4px; }
        .skeleton-chart { height: 300px; border-radius: 12px; }

        /* Temp - Blue */
        #chk-temp:checked + .btn { background-color: rgba(31, 111, 235, 0.15); color: #58a6ff; border-color: #1f6feb; }
        /* Fan - Green */
        #chk-fan:checked + .btn { background-color: rgba(35, 134, 54, 0.15); color: #3fb950; border-color: #238636; }
        /* Power - Gold */
        #chk-pwr:checked + .btn { background-color: rgba(210, 153, 34, 0.15); color: #e3b341; border-color: #d29922; }
        /* CPU - Purple */
        #chk-cpu:checked + .btn { background-color: rgba(163, 113, 247, 0.15); color: #d2a8ff; border-color: #a371f7; }
        /* RAM - Purple */
        #chk-ram:checked + .btn { background-color: rgba(163, 113, 247, 0.15); color: #a371f7; border-color: #a371f7; }

        /* Net In - Green */
        #chk-net-in:checked + .btn { background-color: rgba(46, 160, 67, 0.15); color: #2ea043; border-color: #2ea043; }
        /* Net Out - Blue */
        #chk-net-out:checked + .btn { background-color: rgba(56, 139, 253, 0.15); color: #388bfd; border-color: #388bfd; }
        /* Disk Read - Yellow */
        #chk-disk-r:checked + .btn { background-color: rgba(210, 153, 34, 0.15); color: #d29922; border-color: #d29922; }
        /* Disk Write - Red */
        #chk-disk-w:checked + .btn { background-color: rgba(248, 81, 73, 0.15); color: #f85149; border-color: #f85149; }

        /* GPU Temp - Cyan */
        #chk-gpu-temp:checked + .btn { background-color: rgba(57, 197, 187, 0.15); color: #39c5bb; border-color: #39c5bb; }
        /* GPU Util - Coral Red */
        #chk-gpu-util:checked + .btn { background-color: rgba(255, 123, 114, 0.15); color: #ff7b72; border-color: #ff7b72; }
        /* GPU Power - Red */
        #chk-gpu-pwr:checked + .btn { background-color: rgba(248, 81, 73, 0.15); color: #f85149; border-color: #f85149; }
        /* GPU Memory - Pink */
        #chk-gpu-mem:checked + .btn { background-color: rgba(218, 54, 127, 0.15); color: #da367f; border-color: #da367f; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center position-relative" href="/logs">
            <i class="fas fa-server me-2 text-primary"></i> <span class="fw-bold fs-4">{{ server_name }}</span>
            <span id="log-dot" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none" style="margin-left: -5px; margin-top: 5px">
                <span class="visually-hidden">New Logs</span>
            </span>
        </a>
        <div class="navbar-nav flex-row me-auto ms-4">
            <a class="nav-link me-3" href="/hardware">HW</a>
            <a class="nav-link me-3" href="/resources">RES</a>
            <a class="nav-link me-3" href="/gpu">GPU</a>
            <a class="nav-link active" href="/history">HIST</a>
        </div>
        <a href="/logout" class="btn btn-outline-danger"><i class="fas fa-sign-out-alt"></i></a>
    </div>
</nav>

<div class="container-fluid mt-4 px-3 px-md-4">
    <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center py-3 flex-wrap gap-2">
            <span class="fw-bold fs-5"><i class="fas fa-database me-2"></i>History Explorer</span>
            
            <div class="d-flex gap-3 align-items-center ms-auto">
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="timeRange" id="tr1" value="1" checked onchange="loadData()">
                    <label class="btn btn-outline-secondary px-3" for="tr1">1H</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="tr6" value="6" onchange="loadData()">
                    <label class="btn btn-outline-secondary px-3" for="tr6">6H</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="tr24" value="24" onchange="loadData()">
                    <label class="btn btn-outline-secondary px-3" for="tr24">24H</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="tr72" value="72" onchange="loadData()">
                    <label class="btn btn-outline-secondary px-3" for="tr72">3D</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="tr168" value="168" onchange="loadData()">
                    <label class="btn btn-outline-secondary px-3" for="tr168">7D</label>
                </div>
                <button class="btn btn-sm btn-primary" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
        <div class="card-body d-flex flex-column p-4">
            <!-- 概览统计卡片 -->
            <div class="row g-3 mb-4">
                <div class="col-6 col-lg-3">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Max Temp</div>
                        <div class="h4 mb-0 font-monospace text-primary" id="stat-temp">--°C</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Avg Load</div>
                        <div class="h4 mb-0 font-monospace text-success" id="stat-load">--%</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Peak Net</div>
                        <div class="h4 mb-0 font-monospace text-warning" id="stat-net">-- KB/s</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Peak Disk</div>
                        <div class="h4 mb-0 font-monospace text-info" id="stat-disk">-- MB/s</div>
                    </div>
                </div>
            </div>

            <!-- 维度选择器 - 可横向滑动 -->
            <div class="mb-4 scrollable-tabs-container">
                <input type="checkbox" class="btn-check btn-check-custom" id="chk-temp" checked onchange="handleTagChange()">
                <label class="btn" for="chk-temp"><i class="fas fa-thermometer-half me-1"></i> Temp</label>

                <input type="checkbox" class="btn-check btn-check-custom" id="chk-fan" onchange="handleTagChange()">
                <label class="btn" for="chk-fan"><i class="fas fa-fan me-1"></i> Fan</label>

                <input type="checkbox" class="btn-check btn-check-custom" id="chk-pwr" onchange="handleTagChange()">
                <label class="btn" for="chk-pwr"><i class="fas fa-bolt me-1"></i> Power</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-cpu" checked onchange="handleTagChange()">
               <label class="btn" for="chk-cpu"><i class="fas fa-microchip me-1"></i> CPU</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-ram" onchange="handleTagChange()">
               <label class="btn" for="chk-ram"><i class="fas fa-memory me-1"></i> RAM</label>
               
               <input type="checkbox" class="btn-check btn-check-custom" id="chk-net-in" onchange="handleTagChange()">
               <label class="btn" for="chk-net-in"><i class="fas fa-download me-1"></i> Net In</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-net-out" onchange="handleTagChange()">
               <label class="btn" for="chk-net-out"><i class="fas fa-upload me-1"></i> Net Out</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-disk-r" onchange="handleTagChange()">
               <label class="btn" for="chk-disk-r"><i class="fas fa-hdd me-1"></i> Disk R</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-disk-w" onchange="handleTagChange()">
               <label class="btn" for="chk-disk-w"><i class="fas fa-save me-1"></i> Disk W</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-temp" onchange="handleTagChange()">
               <label class="btn" for="chk-gpu-temp"><i class="fas fa-microchip me-1"></i> GPU Temp</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-util" onchange="handleTagChange()">
               <label class="btn" for="chk-gpu-util"><i class="fas fa-percentage me-1"></i> GPU Util</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-pwr" onchange="handleTagChange()">
               <label class="btn" for="chk-gpu-pwr"><i class="fas fa-bolt me-1"></i> GPU Power</label>

               <input type="checkbox" class="btn-check btn-check-custom chk-io" id="chk-gpu-mem" onchange="handleTagChange()">
               <label class="btn" for="chk-gpu-mem"><i class="fas fa-memory me-1"></i> GPU Memory</label>
            </div>
            
            <div id="skeleton-screen" class="d-flex flex-column gap-5 mt-2 d-none">
                <div class="skeleton skeleton-chart"></div>
                <div class="skeleton skeleton-chart"></div>
                <div class="skeleton skeleton-chart"></div>
            </div>

            <div class="d-flex flex-column gap-5 mt-2" id="charts-wrapper">
                <!-- 图表 A: 热力状态 -->
                <div style="height: 300px; width: 100%">
                    <div class="small text-muted mb-2 text-uppercase fw-bold"><i class="fas fa-thermometer-half me-1"></i> Thermal Status</div>
                    <canvas id="chartTemp"></canvas>
                </div>
                <!-- 图表 B: 算力负载 -->
                <div style="height: 300px; width: 100%">
                    <div class="small text-muted mb-2 text-uppercase fw-bold"><i class="fas fa-microchip me-1"></i> Compute Loads</div>
                    <canvas id="chartLoad"></canvas>
                </div>
                <!-- 图表 C: 吞吐性能 -->
                <div style="height: 300px; width: 100%">
                    <div class="small text-muted mb-2 text-uppercase fw-bold"><i class="fas fa-exchange-alt me-1"></i> I/O Performance</div>
                    <canvas id="chartIO"></canvas>
                </div>
            </div>
            <div id="loading" class="text-center text-muted mt-3" style="display:none"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>
        </div>
    </div>
</div>

<script>
    let charts = { temp: null, load: null, io: null };
    let rawData = {};

    // 准星同步插件
    const crosshairPlugin = {
        id: 'crosshair',
        afterDraw: (chart) => {
            if (chart.crosshair && chart.crosshair.x) {
                const ctx = chart.ctx;
                const x = chart.crosshair.x;
                const top = chart.chartArea.top;
                const bottom = chart.chartArea.bottom;
                ctx.save();
                ctx.beginPath();
                ctx.setLineDash([5, 5]);
                ctx.moveTo(x, top);
                ctx.lineTo(x, bottom);
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#57606a';
                ctx.stroke();
                ctx.restore();
            }
        }
    };

    const baseChartOptions = {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 1000, easing: 'easeOutQuart' },
        interaction: { mode: 'index', intersect: false },
        onHover: (event, elements, chart) => {
            const x = event.x;
            Object.values(charts).forEach(c => {
                if (c && c !== chart) {
                    c.crosshair = { x };
                    // 同步 tooltip
                    const datasetIndex = 0;
                    const items = c.getElementsAtEventForMode(event, 'index', { intersect: false }, true);
                    if (items.length > 0) {
                        c.tooltip.setActiveElements(items, { x: event.x, y: event.y });
                    } else {
                        c.tooltip.setActiveElements([], { x: 0, y: 0 });
                    }
                    c.draw();
                }
            });
            chart.crosshair = { x };
        },
        elements: { 
            point: { radius: 0, hitRadius: 15, hoverRadius: 6 },
            line: { tension: 0.4, borderWidth: 3 } 
        },
        plugins: {
            legend: { 
                position: 'top', align: 'end',
                labels: { color: '#e6edf3', usePointStyle: true, boxWidth: 10, padding: 15, font: { size: 11, weight: 'bold' } } 
            },
            tooltip: { 
                backgroundColor: 'rgba(22, 27, 34, 0.98)', borderColor: '#444c56', borderWidth: 1, 
                titleColor: '#fff', bodyColor: '#e6edf3', padding: 12, bodySpacing: 8,
                titleFont: { size: 14, weight: 'bold' }, bodyFont: { family: "'SF Mono', monospace" }
            }
        },
        scales: {
            x: { grid: { color: 'rgba(48, 54, 61, 0.4)', drawBorder: false }, ticks: { color: '#8b949e', font: { size: 11 }, maxTicksLimit: 10 } },
            y: { grid: { color: 'rgba(48, 54, 61, 0.4)', drawBorder: false }, ticks: { color: '#8b949e', font: { family: "'SF Mono', monospace", size: 11 } } },
            y1: { type: 'linear', display: false, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#8b949e', font: { family: "'SF Mono', monospace", size: 11 } } }
        }
    };

    function init() {
        // 注册插件
        Chart.register(crosshairPlugin);
        
        charts.temp = new Chart(document.getElementById('chartTemp'), { type: 'line', data: { labels: [], datasets: [] }, options: baseChartOptions });
        charts.load = new Chart(document.getElementById('chartLoad'), { type: 'line', data: { labels: [], datasets: [] }, options: baseChartOptions });
        charts.io = new Chart(document.getElementById('chartIO'), { type: 'line', data: { labels: [], datasets: [] }, options: baseChartOptions });
        
        loadPrefs();
        loadData();
    }

    function handleTagChange() {
        savePrefs();
        updateChart();
    }

    function savePrefs() {
        const prefs = {};
        document.querySelectorAll('.btn-check-custom').forEach(el => {
            prefs[el.id] = el.checked;
        });
        localStorage.setItem('hist_tags', JSON.stringify(prefs));
    }

    function loadPrefs() {
        const data = localStorage.getItem('hist_tags');
        if (data) {
            const prefs = JSON.parse(data);
            Object.keys(prefs).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = prefs[id];
            });
        } else {
            // 默认全选
            document.querySelectorAll('.btn-check-custom').forEach(el => el.checked = true);
        }
    }

    function createGradient(ctx, color) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, color + '33');
        gradient.addColorStop(1, color + '00');
        return gradient;
    }

    function loadData() {
        const rangeEl = document.querySelector('input[name="timeRange"]:checked');
        const hours = rangeEl ? rangeEl.value : 1;
        
        const wrapper = document.getElementById('charts-wrapper');
        const skeleton = document.getElementById('skeleton-screen');
        wrapper.classList.add('opacity-25');
        skeleton.classList.remove('d-none');
        
        // 请求系统历史 (现在已经包含了对齐后的 GPU 历史数据)
        fetch(`/api/history_custom?hours=${hours}`).then(r => r.json()).then(sys => {
            rawData = sys;
            wrapper.classList.remove('opacity-25');
            skeleton.classList.add('d-none');
            updateChart();
        }).catch(e => {
            console.error(e);
            skeleton.classList.add('d-none');
            wrapper.classList.remove('opacity-25');
        });
    }

    function updateChart() {
        if (!rawData.times) return;

        // 如果后端返回了全局统计数据，直接使用
        if (rawData.stats) {
            document.getElementById('stat-temp').innerText = (rawData.stats.max_temp || '--') + '°C';
            document.getElementById('stat-load').innerText = (rawData.stats.avg_load || '--') + '%';
            document.getElementById('stat-net').innerText = (rawData.stats.max_net || '--') + ' KB/s';
            document.getElementById('stat-disk').innerText = (rawData.stats.max_disk || '--') + ' MB/s';
        }

        const dsTemp = [], dsLoad = [], dsIO = [];
        const ctxTemp = document.getElementById('chartTemp').getContext('2d');
        const ctxLoad = document.getElementById('chartLoad').getContext('2d');
        const ctxIO = document.getElementById('chartIO').getContext('2d');

        // --- 热力图表 (Temp + Fan) ---
        if(document.getElementById('chk-temp').checked) 
            dsTemp.push({label:'CPU Temp', data:rawData.cpu_temp, borderColor:'#1f6feb', backgroundColor: createGradient(ctxTemp, '#1f6feb'), fill: true});
        if(rawData.gpu && rawData.gpu.temp && document.getElementById('chk-gpu-temp').checked)
            dsTemp.push({label:'GPU Temp', data:rawData.gpu.temp, borderColor:'#39c5bb', backgroundColor: createGradient(ctxTemp, '#39c5bb'), fill: true});
        if(document.getElementById('chk-fan').checked) 
            dsTemp.push({label:'Fan Speed', data:rawData.fan_rpm, borderColor:'#3fb950', yAxisID: 'y1'});
        if(document.getElementById('chk-pwr').checked) 
            dsTemp.push({label:'Sys Power', data:rawData.power, borderColor:'#d29922', yAxisID: 'y1'});
        if(rawData.gpu && rawData.gpu.power && document.getElementById('chk-gpu-pwr').checked)
            dsTemp.push({label:'GPU Power', data:rawData.gpu.power, borderColor:'#f85149', yAxisID: 'y1'});

        // --- 负载图表 (Load + GPU Mem) ---
        if(document.getElementById('chk-cpu').checked)
            dsLoad.push({label:'CPU Util', data:rawData.cpu_load, borderColor:'#79c0ff', backgroundColor: createGradient(ctxLoad, '#79c0ff'), fill: true});
        if(document.getElementById('chk-ram').checked)
            dsLoad.push({label:'RAM Util', data:rawData.mem_load, borderColor:'#bc8cff', backgroundColor: createGradient(ctxLoad, '#bc8cff'), fill: true});
        if(rawData.gpu && rawData.gpu.util_gpu && document.getElementById('chk-gpu-util').checked)
            dsLoad.push({label:'GPU Util', data:rawData.gpu.util_gpu, borderColor:'#ff7b72', backgroundColor: createGradient(ctxLoad, '#ff7b72'), fill: true});
        if(rawData.gpu && rawData.gpu.mem_used && document.getElementById('chk-gpu-mem').checked)
            dsLoad.push({label:'GPU Mem', data:rawData.gpu.mem_used, borderColor:'#da367f', yAxisID: 'y1'});

        // --- IO 图表 ---
        if(document.getElementById('chk-net-in').checked)
            dsIO.push({label:'Net In', data:rawData.net_in, borderColor:'#2ea043'});
        if(document.getElementById('chk-net-out').checked)
            dsIO.push({label:'Net Out', data:rawData.net_out, borderColor:'#388bfd'});
        if(document.getElementById('chk-disk-r').checked)
            dsIO.push({label:'Disk R', data:rawData.disk_r, borderColor:'#d29922'});
        if(document.getElementById('chk-disk-w').checked)
            dsIO.push({label:'Disk W', data:rawData.disk_w, borderColor:'#f85149'});

        // 更新三个图表
        const updateSingleChart = (chart, ds) => {
            chart.data.labels = rawData.times;
            chart.data.datasets = ds;
            chart.options.scales.y1.display = ds.some(d => d.yAxisID === 'y1');
            chart.update();
        };

        updateSingleChart(charts.temp, dsTemp);
        updateSingleChart(charts.load, dsLoad);
        updateSingleChart(charts.io, dsIO);
    }

    function checkLogStatus() {
        fetch('/api/log_status').then(r => r.json()).then(d => {
            const dot = document.getElementById('log-dot');
            if (d.unread) dot.classList.remove('d-none');
            else dot.classList.add('d-none');
        });
    }

    init();
    checkLogStatus();
    setInterval(checkLogStatus, 30000);
</script>
</body>
</html>
