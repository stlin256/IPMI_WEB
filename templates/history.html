<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>History - {{ server_name }} Ops</title>
   <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
   <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
   <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
   <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <style>
        :root { --bg-body: #0d1117; --bg-card: #161b22; --border-color: #30363d; --text-main: #e6edf3; --text-muted: #8b949e; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: "Segoe UI", system-ui, sans-serif; min-height: 100vh; display: flex; flex-direction: column; margin: 0; }
        .navbar { background-color: rgba(22, 27, 34, 0.95) !important; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .nav-link { color: var(--text-muted) !important; font-weight: 500; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { color: #fff !important; }

        @media (max-width: 576px) {
            .navbar-brand { font-size: 1.2rem !important; margin-right: 0.5rem !important; }
            .navbar-nav.me-auto { margin-left: 0.5rem !important; }
            .nav-link { font-size: 0.9rem !important; margin-right: 0.5rem !important; padding-left: 0.2rem !important; padding-right: 0.2rem !important; }
            .btn-outline-danger { padding: 0.25rem 0.5rem !important; font-size: 0.8rem !important; }
        }
        
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 8px 24px rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; }
        .card-header { background-color: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border-color); padding: 1.25rem; }
        
        .form-select { background-color: #21262d; border-color: #30363d; color: #c9d1d9; border-radius: 6px; padding: 0.4rem 0.8rem; }
        .form-select:focus { border-color: #58a6ff; box-shadow: none; }
        
        /* 横向滚动容器 */
        .scrollable-tabs-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding: 10px 0;
            gap: 10px;
            scrollbar-width: none; /* Firefox */
        }
        .scrollable-tabs-container::-webkit-scrollbar { display: none; }
        
        /* 胶囊样式优化 */
        .btn-check-custom + .btn { 
            border-color: #444c56; color: var(--text-muted); background: #21262d; 
            border-radius: 8px; padding: 0.5rem 1.25rem; font-size: 0.95rem; font-weight: 600;
            white-space: nowrap; transition: all 0.2s;
        }
        .btn-check-custom:hover + .btn { background: #30363d; color: #fff; border-color: #57606a; }

        /* Insights Mobile Adjustments */
        @media (max-width: 768px) {
            .insights-chart-container { height: 180px !important; }
            #btn-insights-text { font-size: 0.85rem !important; }
            #btn-insights-icon { display: none !important; }
        }

        /* 骨架屏动画 */
        .skeleton { background: linear-gradient(90deg, #161b22 25%, #21262d 50%, #161b22 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-text { height: 1.5rem; margin-bottom: 0.5rem; border-radius: 4px; }
        .skeleton-chart { height: 300px; border-radius: 12px; }

        /* CPU Temp - Blue (#1f6feb) */
        #chk-temp:checked + .btn { background-color: rgba(31, 111, 235, 0.15); color: #79c0ff; border-color: #1f6feb; }
        /* Fan - Green (#3fb950) */
        #chk-fan:checked + .btn { background-color: rgba(63, 185, 80, 0.15); color: #3fb950; border-color: #238636; }
        /* Sys Power - Gold (#d29922) */
        #chk-pwr:checked + .btn { background-color: rgba(210, 153, 34, 0.15); color: #e3b341; border-color: #d29922; }
        
        /* CPU Util - Light Blue (#79c0ff) */
        #chk-cpu:checked + .btn { background-color: rgba(121, 192, 255, 0.15); color: #79c0ff; border-color: #58a6ff; }
        /* RAM Util - Purple (#bc8cff) */
        #chk-ram:checked + .btn { background-color: rgba(188, 140, 255, 0.15); color: #bc8cff; border-color: #a371f7; }

        /* Net In - Deep Green (#2ea043) */
        #chk-net-in:checked + .btn { background-color: rgba(46, 160, 67, 0.15); color: #3fb950; border-color: #2ea043; }
        /* Net Out - Blue (#388bfd) */
        #chk-net-out:checked + .btn { background-color: rgba(56, 139, 253, 0.15); color: #79c0ff; border-color: #388bfd; }
        /* Disk Read - Yellow (#d29922) */
        #chk-disk-r:checked + .btn { background-color: rgba(210, 153, 34, 0.15); color: #e3b341; border-color: #d29922; }
        /* Disk Write - Red (#f85149) */
        #chk-disk-w:checked + .btn { background-color: rgba(248, 81, 73, 0.15); color: #ff7b72; border-color: #f85149; }

        /* GPU Temp - Cyan (#39c5bb) */
        #chk-gpu-temp:checked + .btn { background-color: rgba(57, 197, 187, 0.15); color: #39c5bb; border-color: #39c5bb; }
        /* GPU Util - Coral Red (#ff7b72) */
        #chk-gpu-util:checked + .btn { background-color: rgba(255, 123, 114, 0.15); color: #ff7b72; border-color: #ff7b72; }
        /* GPU Power - Red (#f85149) */
        #chk-gpu-pwr:checked + .btn { background-color: rgba(248, 81, 73, 0.15); color: #f85149; border-color: #f85149; }
        /* GPU Memory - Pink (#da367f) */
        #chk-gpu-mem:checked + .btn { background-color: rgba(218, 54, 127, 0.15); color: #da367f; border-color: #da367f; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center position-relative" href="/logs">
            <i class="fas fa-server me-2 text-primary"></i> <span class="fw-bold fs-4">{{ server_name }}</span>
            <span id="log-dot" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none" style="margin-left: -5px; margin-top: 5px">
                <span class="visually-hidden">New Logs</span>
            </span>
        </a>
        <div class="navbar-nav flex-row me-auto ms-4">
            <a class="nav-link me-3" href="/hardware">HW</a>
            <a class="nav-link me-3" href="/resources">RES</a>
            <a class="nav-link me-3" href="/gpu">GPU</a>
            <a class="nav-link active" href="/history">HIST</a>
        </div>
        <a href="/logout" class="btn btn-outline-danger"><i class="fas fa-sign-out-alt"></i></a>
    </div>
</nav>

<div class="container-fluid mt-4 px-3 px-md-4">
    <!-- Energy Date Modal -->
    <div class="modal fade" id="energyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-secondary shadow-lg bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Set Energy Start Date</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted small mb-3">Calculate cumulative energy consumption from this date:</p>
                    <input type="date" id="energyInput" class="form-control bg-dark text-light border-secondary mb-3">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary flex-grow-1" onclick="saveEnergyDate()">Apply</button>
                        <button class="btn btn-outline-secondary" onclick="resetEnergyDate()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center py-3 flex-wrap gap-3">
            <div class="d-flex align-items-center gap-2">
                <span class="fw-bold fs-5"><i class="fas fa-database me-2"></i>History Explorer</span>
                <button class="btn btn-sm btn-outline-secondary px-2 border-0" onclick="exportData()" title="Export CSV Data">
                    <i class="fas fa-file-export"></i>
                </button>
            </div>
            
            <div class="d-flex gap-1 gap-md-3 align-items-center ms-auto flex-wrap justify-content-end">
                <button class="btn btn-sm btn-outline-info px-2 px-md-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInsights">
                    <i id="btn-insights-icon" class="fas fa-lightbulb me-1"></i> <span id="btn-insights-text">Insights</span>
                </button>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="timeRange" id="tr1" value="1" checked onchange="loadData()">
                    <label class="btn btn-outline-secondary px-2 px-md-3" for="tr1">1H</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="tr6" value="6" onchange="loadData()">
                    <label class="btn btn-outline-secondary px-2 px-md-3" for="tr6">6H</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="tr24" value="24" onchange="loadData()">
                    <label class="btn btn-outline-secondary px-2 px-md-3" for="tr24">24H</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="tr72" value="72" onchange="loadData()">
                    <label class="btn btn-outline-secondary px-2 px-md-3" for="tr72">3D</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="tr168" value="168" onchange="loadData()">
                    <label class="btn btn-outline-secondary px-2 px-md-3" for="tr168">7D</label>
                </div>
                <button class="btn btn-sm btn-primary px-2 px-md-3" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
        <div class="card-body d-flex flex-column p-4">
            <!-- Insights Section (Collapsed by default) -->
            <div class="collapse mb-4" id="collapseInsights">
                <div id="deep-analysis-section" class="bg-dark bg-opacity-25 rounded-3 p-4 border border-info border-opacity-10">
                    <div class="d-flex align-items-center mb-4">
                        <div class="h4 mb-0 fw-bold text-info"><i class="fas fa-lightbulb me-2"></i>Insights</div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-12 col-xl-4">
                            <div class="card bg-dark bg-opacity-25 h-100 p-3">
                                <div class="small text-muted mb-3 text-uppercase fw-bold">Power Contribution</div>
                                <div class="insights-chart-container" style="height: 250px">
                                    <canvas id="chartPowerDist"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12 col-xl-8">
                            <div class="card bg-dark bg-opacity-25 h-100 p-3">
                                <div class="small text-muted mb-3 text-uppercase fw-bold">Load Intensity</div>
                                <div class="insights-chart-container" style="height: 250px">
                                    <canvas id="chartLoadDist"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-xl-6">
                            <div class="card bg-dark bg-opacity-25 h-100 p-3">
                                <div class="small text-muted mb-3 text-uppercase fw-bold">VRAM Efficiency</div>
                                <div class="insights-chart-container" style="height: 300px">
                                    <canvas id="chartVRAMEff"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-xl-6">
                            <div class="card bg-dark bg-opacity-25 h-100 p-3">
                                <div class="small text-muted mb-3 text-uppercase fw-bold">Thermal Stability</div>
                                <div class="insights-chart-container" style="height: 300px">
                                    <canvas id="chartTempDist"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 概览统计卡片 -->
            <div class="row g-3 mb-4 row-cols-2 row-cols-md-3 row-cols-xl-6">
                <div class="col">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center h-100">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Max Temp</div>
                        <div class="h4 mb-0 font-monospace text-primary" id="stat-temp">--°C</div>
                    </div>
                </div>
                <div class="col">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center h-100">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Avg Load</div>
                        <div class="h4 mb-0 font-monospace text-success" id="stat-load">--%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center h-100">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Peak Net</div>
                        <div class="h4 mb-0 font-monospace text-warning" id="stat-net">-- KB/s</div>
                    </div>
                </div>
                <div class="col">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center h-100">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Peak Disk</div>
                        <div class="h4 mb-0 font-monospace text-info" id="stat-disk">-- MB/s</div>
                    </div>
                </div>
                <div class="col">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center h-100">
                        <div class="text-uppercase small text-muted fw-bold mb-1">Interval</div>
                        <div class="h4 mb-0 font-monospace text-warning" id="stat-energy-interval">-- kWh</div>
                    </div>
                </div>
                <div class="col">
                    <div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-25 text-center h-100" style="cursor: pointer" onclick="changeEnergyStartDate()" title="Click to change start date">
                        <div class="text-uppercase small text-muted fw-bold mb-1" id="energy-total-title">Energy</div>
                        <div class="h4 mb-0 font-monospace text-danger" id="stat-energy-total">-- kWh</div>
                        <div class="small text-muted mt-1" id="stat-energy-date" style="font-size: 0.65rem; white-space: nowrap">since --</div>
                    </div>
                </div>
            </div>

            <!-- 维度选择器 - 可横向滑动 -->
            <div class="mb-4 scrollable-tabs-container">
                <input type="checkbox" class="btn-check btn-check-custom" id="chk-temp" checked onchange="handleTagChange()">
                <label class="btn" for="chk-temp"><i class="fas fa-thermometer-half me-1"></i> Temp</label>

                <input type="checkbox" class="btn-check btn-check-custom" id="chk-fan" onchange="handleTagChange()">
                <label class="btn" for="chk-fan"><i class="fas fa-fan me-1"></i> Fan</label>

                <input type="checkbox" class="btn-check btn-check-custom" id="chk-pwr" onchange="handleTagChange()">
                <label class="btn" for="chk-pwr"><i class="fas fa-bolt me-1"></i> Power</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-cpu" checked onchange="handleTagChange()">
               <label class="btn" for="chk-cpu"><i class="fas fa-microchip me-1"></i> CPU</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-ram" onchange="handleTagChange()">
               <label class="btn" for="chk-ram"><i class="fas fa-memory me-1"></i> RAM</label>
               
               <input type="checkbox" class="btn-check btn-check-custom" id="chk-net-in" onchange="handleTagChange()">
               <label class="btn" for="chk-net-in"><i class="fas fa-download me-1"></i> Net In</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-net-out" onchange="handleTagChange()">
               <label class="btn" for="chk-net-out"><i class="fas fa-upload me-1"></i> Net Out</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-disk-r" onchange="handleTagChange()">
               <label class="btn" for="chk-disk-r"><i class="fas fa-hdd me-1"></i> Disk R</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-disk-w" onchange="handleTagChange()">
               <label class="btn" for="chk-disk-w"><i class="fas fa-save me-1"></i> Disk W</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-temp" onchange="handleTagChange()">
               <label class="btn" for="chk-gpu-temp"><i class="fas fa-microchip me-1"></i> GPU Temp</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-util" onchange="handleTagChange()">
               <label class="btn" for="chk-gpu-util"><i class="fas fa-percentage me-1"></i> GPU Util</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-pwr" onchange="handleTagChange()">
               <label class="btn" for="chk-gpu-pwr"><i class="fas fa-bolt me-1"></i> GPU Power</label>

               <input type="checkbox" class="btn-check btn-check-custom chk-io" id="chk-gpu-mem" onchange="handleTagChange()">
               <label class="btn" for="chk-gpu-mem"><i class="fas fa-memory me-1"></i> GPU Memory</label>
            </div>
            
            <div id="skeleton-screen" class="d-flex flex-column gap-5 mt-2 d-none">
                <div class="skeleton skeleton-chart"></div>
                <div class="skeleton skeleton-chart"></div>
                <div class="skeleton skeleton-chart"></div>
            </div>

            <div class="d-flex flex-column gap-5 mt-2" id="charts-wrapper">
                <!-- 原始历史图表 -->
                <div class="pt-3">
                    <div class="h4 mb-3 fw-bold text-muted"><i class="fas fa-chart-line me-2"></i>History</div>
                    <div class="d-flex flex-column gap-5">
                        <div style="height: 300px; width: 100%">
                            <div class="small text-muted mb-2 text-uppercase fw-bold"><i class="fas fa-thermometer-half me-1"></i> Thermal Status</div>
                            <canvas id="chartTemp"></canvas>
                        </div>
                        <div style="height: 300px; width: 100%">
                            <div class="small text-muted mb-2 text-uppercase fw-bold"><i class="fas fa-microchip me-1"></i> Compute Loads</div>
                            <canvas id="chartLoad"></canvas>
                        </div>
                        <div style="height: 300px; width: 100%">
                            <div class="small text-muted mb-2 text-uppercase fw-bold"><i class="fas fa-exchange-alt me-1"></i> I/O Performance</div>
                            <canvas id="chartIO"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div id="loading" class="text-center text-muted mt-3" style="display:none"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>
        </div>
    </div>
</div>

<script>
    let charts = { temp: null, load: null, io: null, pwrDist: null, loadDist: null, vramEff: null, tempDist: null };
    let rawData = {};
    let isBaseDataLoading = false;

    // 准星同步插件 (增加 group_id 隔离逻辑)
    const crosshairPlugin = {
        id: 'crosshair',
        afterDraw: (chart) => {
            // 只有当鼠标在当前图表内或被同步时才绘制
            if (chart.crosshair && chart.crosshair.x && chart.crosshair.active) {
                const ctx = chart.ctx;
                const x = chart.crosshair.x;
                const top = chart.chartArea.top;
                const bottom = chart.chartArea.bottom;
                ctx.save();
                ctx.beginPath();
                ctx.setLineDash([5, 5]);
                ctx.moveTo(x, top);
                ctx.lineTo(x, bottom);
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#57606a';
                ctx.stroke();
                ctx.restore();
            }
        }
    };

    const baseChartOptions = {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 1000, easing: 'easeOutQuart' },
        interaction: { mode: 'index', intersect: false },
        group_id: 'history_group', // 默认组 ID
        onHover: (event, elements, chart) => {
            const x = event.x;
            const y = event.y;
            const isOut = !chart.chartArea || 
                          x < chart.chartArea.left || x > chart.chartArea.right || 
                          y < chart.chartArea.top || y > chart.chartArea.bottom;
            
            Object.values(charts).forEach(c => {
                if (!c) return;
                // 核心隔离逻辑：只有 group_id 相同的图表才相互同步
                if (c.options.group_id === chart.options.group_id) {
                    if (isOut) {
                        c.crosshair = { x: null, active: false };
                        if (c.tooltip) c.tooltip.setActiveElements([], { x: 0, y: 0 });
                    } else {
                        c.crosshair = { x, active: true };
                        if (c.tooltip) {
                            const items = c.getElementsAtEventForMode(event, 'index', { intersect: false }, true);
                            c.tooltip.setActiveElements(items || [], { x: event.x, y: event.y });
                        }
                    }
                    c.draw();
                }
            });
        },
        elements: { 
            point: { radius: 0, hitRadius: 15, hoverRadius: 6 },
            line: { tension: 0.4, borderWidth: 2 } 
        },
        plugins: {
            legend: { 
                position: 'top', align: 'end',
                labels: { color: '#e6edf3', usePointStyle: true, boxWidth: 10, padding: 15, font: { size: 11, weight: 'bold' } } 
            },
            tooltip: { 
                backgroundColor: 'rgba(22, 27, 34, 0.98)', borderColor: '#444c56', borderWidth: 1, 
                titleColor: '#fff', bodyColor: '#e6edf3', padding: 12, bodySpacing: 8,
                titleFont: { size: 14, weight: 'bold' }, bodyFont: { family: "'SF Mono', monospace" }
            }
        },
        scales: {
            x: { grid: { color: 'rgba(48, 54, 61, 0.4)', drawBorder: false }, ticks: { color: '#8b949e', font: { size: 11 }, maxTicksLimit: 10 } },
            y: { grid: { color: 'rgba(48, 54, 61, 0.4)', drawBorder: false }, ticks: { color: '#8b949e', font: { family: "'SF Mono', monospace", size: 11 } } },
            y1: { type: 'linear', display: false, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#8b949e', font: { family: "'SF Mono', monospace", size: 11 } } }
        }
    };

    function init() {
        // 监听所有图表容器的鼠标移出，确保清理状态
        ['chartTemp', 'chartLoad', 'chartIO'].forEach(id => {
            const canvas = document.getElementById(id);
            if (canvas) {
                canvas.addEventListener('mouseleave', () => {
                    Object.values(charts).forEach(c => {
                        if (c && c.options.group_id === 'history_group') {
                            c.crosshair = { x: null, active: false };
                            if (c.tooltip) c.tooltip.setActiveElements([], { x: 0, y: 0 });
                            c.draw();
                        }
                    });
                });
            }
        });

        // 监听 Insights 折叠展开事件，实现懒加载
        const collapseEl = document.getElementById('collapseInsights');
        collapseEl.addEventListener('show.bs.collapse', () => {
            // 如果正在加载基础数据，或者基础数据还没加载完，点开立刻处理
            // 如果基础数据加载完了，loadInsights 内部会判断是否需要重新请求
            loadInsights();
        });

        // 注册插件
        Chart.register(crosshairPlugin);
        
        charts.temp = new Chart(document.getElementById('chartTemp'), { type: 'line', data: { labels: [], datasets: [] }, options: baseChartOptions });
        charts.load = new Chart(document.getElementById('chartLoad'), { type: 'line', data: { labels: [], datasets: [] }, options: baseChartOptions });
        charts.io = new Chart(document.getElementById('chartIO'), { type: 'line', data: { labels: [], datasets: [] }, options: baseChartOptions });
        
        // --- 初始化深度分析图表 (禁用全局准星同步，自定义 Y 轴百分比) ---
        const deepCommonOptions = {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            group_id: 'insights_group', // 独立的组 ID，防止跨组同步
            onHover: (event, elements, chart) => {
                // Insights 组内不再跨表同步准星
                const x = event.x;
                const isOut = event.type === 'mouseout' || !chart.chartArea || x < chart.chartArea.left || x > chart.chartArea.right;
                
                // 只有 Thermal Stability (tempDist) 需要准星
                if (chart === charts.tempDist) {
                    if (isOut) {
                        chart.crosshair = { x: null, active: false };
                    } else {
                        chart.crosshair = { x, active: true };
                    }
                    chart.draw();
                }
            },
            plugins: {
                legend: { position: 'top', align: 'end', labels: { color: '#8b949e', usePointStyle: true, boxWidth: 8 } },
                tooltip: { backgroundColor: 'rgba(22, 27, 34, 0.95)', titleColor: '#fff' }
            }
        };
        
        charts.pwrDist = new Chart(document.getElementById('chartPowerDist'), {
            type: 'doughnut',
            data: { labels: ['CPU + Others', 'GPU'], datasets: [{ data: [0, 0], backgroundColor: ['#1f6feb', '#39c5bb'], borderWidth: 0 }] },
            options: { 
                ...deepCommonOptions, 
                cutout: '70%', 
                onHover: null, 
                plugins: { 
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) label += ': ';
                                if (context.parsed !== undefined) label += context.parsed.toFixed(1) + '%';
                                return label;
                            }
                        }
                    }
                } 
            }
        });

        const pctScale = { 
            min: 0, max: 100, 
            ticks: { color: '#8b949e', callback: v => v + '%' },
            grid: { color: 'rgba(48,54,61,0.2)', drawBorder: false }
        };

        charts.loadDist = new Chart(document.getElementById('chartLoadDist'), {
            type: 'bar',
            data: { labels: ['<10%', '10-30%', '30-60%', '60-90%', '>90%'], datasets: [] },
            options: { 
                ...deepCommonOptions, 
                scales: { x: { grid: { display: false } }, y: pctScale },
                plugins: {
                    ...deepCommonOptions.plugins,
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== undefined) label += context.parsed.y.toFixed(1) + '%';
                                return label;
                            }
                        }
                    }
                }
            }
        });

        charts.vramEff = new Chart(document.getElementById('chartVRAMEff'), {
            type: 'bubble',
            data: { datasets: [{ label: 'GPU efficiency', data: [], backgroundColor: 'rgba(57, 197, 187, 0.5)', borderColor: 'rgba(57, 197, 187, 0.8)', borderWidth: 1 }] },
            options: { 
                ...deepCommonOptions,
                interaction: { mode: 'nearest', intersect: true }, // 修正气泡图交互模式
                onHover: null,
                scales: { 
                    x: { ...pctScale, title: { display: true, text: 'GPU Core Util %', color: '#8b949e' } },
                    y: { ...pctScale, title: { display: true, text: 'VRAM Util %', color: '#8b949e' } }
                },
                plugins: {
                    ...deepCommonOptions.plugins,
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Core: ${context.raw.x}% | VRAM: ${context.raw.y}%`;
                            }
                        }
                    }
                }
            }
        });

        charts.tempDist = new Chart(document.getElementById('chartTempDist'), {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: { 
                ...deepCommonOptions, 
                fill: true, 
                elements: { line: { tension: 0.4, borderWidth: 2 } },
                scales: { x: { grid: { display: false } }, y: pctScale },
                plugins: {
                    ...deepCommonOptions.plugins,
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== undefined) label += context.parsed.y.toFixed(2) + '%';
                                return label;
                            }
                        }
                    }
                }
            }
        });

        loadPrefs();
        loadData();
    }

    function handleTagChange() {
        savePrefs();
        updateChart();
    }

    function savePrefs() {
        const prefs = {};
        document.querySelectorAll('.btn-check-custom').forEach(el => {
            prefs[el.id] = el.checked;
        });
        localStorage.setItem('hist_tags', JSON.stringify(prefs));
    }

    function loadPrefs() {
        const data = localStorage.getItem('hist_tags');
        if (data) {
            const prefs = JSON.parse(data);
            Object.keys(prefs).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = prefs[id];
            });
        } else {
            // 默认全选
            document.querySelectorAll('.btn-check-custom').forEach(el => el.checked = true);
        }
    }

    function createGradient(ctx, color) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, color + '33');
        gradient.addColorStop(1, color + '00');
        return gradient;
    }

    let lastInsightsHours = -1;

    function loadInsights() {
        const rangeEl = document.querySelector('input[name="timeRange"]:checked');
        const hours = rangeEl ? parseInt(rangeEl.value) : 1;
        
        // 如果时间范围没变且数据已存在，跳过重复请求
        if (hours === lastInsightsHours && rawData.analysis) return;

        // 为 Insights 区域的四个图表卡片分别添加骨架屏覆盖
        const insightCardSelectors = [
            '#chartPowerDist',
            '#chartLoadDist',
            '#chartVRAMEff',
            '#chartTempDist'
        ];

        insightCardSelectors.forEach(selector => {
            const canvas = document.querySelector(selector);
            if (canvas) {
                const card = canvas.closest('.card');
                if (card) {
                    card.classList.add('position-relative');
                    if (!card.querySelector('.insights-mask')) {
                        const mask = document.createElement('div');
                        mask.className = 'skeleton rounded-3 position-absolute top-0 start-0 w-100 h-100 insights-mask';
                        mask.style.backgroundColor = 'var(--bg-card)';
                        mask.style.zIndex = '10';
                        card.appendChild(mask);
                    }
                }
            }
        });

        fetch(`/api/insights?hours=${hours}`).then(r => r.json()).then(data => {
            rawData.analysis = data;
            lastInsightsHours = hours;
            
            // 移除 Insights 区域的所有覆盖遮罩
            document.querySelectorAll('.insights-mask').forEach(m => m.remove());
            
            updateInsightsCharts();
        }).catch(e => {
            console.error('Insights Load Error:', e);
            document.querySelectorAll('.insights-mask').forEach(m => m.remove());
        });
    }

    function loadData() {
        const rangeEl = document.querySelector('input[name="timeRange"]:checked');
        const hours = rangeEl ? rangeEl.value : 1;
        
        const wrapper = document.getElementById('charts-wrapper');
        const skeleton = document.getElementById('skeleton-screen');
        
        wrapper.classList.add('opacity-25');
        skeleton.classList.remove('d-none');
        isBaseDataLoading = true;

        // 为 6 个统计卡片应用背景覆盖流光效果
        const statIds = ['stat-temp', 'stat-load', 'stat-net', 'stat-disk', 'stat-energy-interval', 'stat-energy-total'];
        statIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.parentElement.classList.add('position-relative');
                if (!document.getElementById('mask-' + id)) {
                    const mask = document.createElement('div');
                    mask.id = 'mask-' + id;
                    mask.className = 'skeleton rounded-2 position-absolute top-0 start-0 w-100 h-100';
                    mask.style.backgroundColor = 'var(--bg-card)';
                    mask.style.zIndex = '5';
                    el.parentElement.appendChild(mask);
                }
            }
        });
        
        const isInsightsShown = document.getElementById('collapseInsights').classList.contains('show');
        
        // 逻辑修正：
        // 1. 如果是展开的，那么同时处理
        if (isInsightsShown) {
            loadInsights();
        } else {
            // 如果没展开，标记数据已过期，下次打开时再请求
            rawData.analysis = null;
            lastInsightsHours = -1;
        }

        const energyStart = localStorage.getItem('energy_start_ts') || 0;
        
        // 请求基础历史数据 (不包含 heavy insights 计算)
        fetch(`/api/history_custom?hours=${hours}&energy_start=${energyStart}`).then(r => r.json()).then(sys => {
            isBaseDataLoading = false;
            rawData = { ...rawData, ...sys }; // 合并数据，保留分析结果
            wrapper.classList.remove('opacity-25');
            skeleton.classList.add('d-none');
            
            // 移除 6 个统计卡片的背景覆盖遮罩
            statIds.forEach(id => {
                const m = document.getElementById('mask-' + id);
                if (m) m.remove();
            });
            
            updateChart();

            // 2. 如果不展开，那就是先处理图表，加载后再处理上面的 (如果展开了就不需要在这里再次触发了)
            if (!isInsightsShown && document.getElementById('collapseInsights').classList.contains('show')) {
                // 这种情况属于加载一半点开了，或者在加载完瞬间点开了
                loadInsights();
            } else if (!isInsightsShown) {
                // 这里其实可以不主动加载，直到用户点开。
                // 但按要求：如果不展开，“加载后再处理上面的”，可能意味着即使没展开也要在后台静默加载？
                // 重新阅读要求：“如果不展开...那就是先处理下面的图表，加载后再处理上面的”
                // 这可能意味着即便没展开，加载完图表后也应该去加载 insights 数据，以便点开时立刻显示。
                loadInsights();
            }
        }).catch(e => {
            isBaseDataLoading = false;
            console.error(e);
            skeleton.classList.add('d-none');
            wrapper.classList.remove('opacity-25');
            statIds.forEach(id => {
                const m = document.getElementById('mask-' + id);
                if (m) m.remove();
            });
        });
    }

    let energyModal = null;
    function changeEnergyStartDate() {
        const current = document.getElementById('stat-energy-date').innerText.replace('since ', '');
        const input = document.getElementById('energyInput');
        input.value = current === '--' ? '' : current;
        
        // 设置可选的最早日期
        if (rawData.stats && rawData.stats.energy_earliest_date) {
            input.min = rawData.stats.energy_earliest_date;
        }
        // 设置可选的最晚日期 (今天)
        input.max = new Date().toISOString().split('T')[0];
        
        if (!energyModal) {
            energyModal = new bootstrap.Modal(document.getElementById('energyModal'));
        }
        energyModal.show();
    }

    function saveEnergyDate() {
        const newDate = document.getElementById('energyInput').value;
        if (newDate) {
            // 使用替换 - 以兼容不同浏览器对 Date 构造函数的支持
            const parts = newDate.split('-');
            const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
            const ts = Math.floor(dateObj.getTime() / 1000);
            if (!isNaN(ts)) {
                localStorage.setItem('energy_start_ts', ts);
                if (energyModal) energyModal.hide();
                loadData();
            }
        }
    }

    function resetEnergyDate() {
        localStorage.removeItem('energy_start_ts');
        if (energyModal) energyModal.hide();
        loadData();
    }

    function updateChart() {
        if (!rawData.times) return;

        // 如果后端返回了全局统计数据，直接使用
        if (rawData.stats) {
            document.getElementById('stat-temp').innerText = (rawData.stats.max_temp || '--') + '°C';
            document.getElementById('stat-load').innerText = (rawData.stats.avg_load || '--') + '%';
            
            // Peak Net 动态单位
            let netVal = rawData.stats.max_net || 0;
            if (netVal >= 10240) {
                document.getElementById('stat-net').innerText = (netVal / 1024).toFixed(2) + ' MB/s';
            } else {
                document.getElementById('stat-net').innerText = netVal + ' KB/s';
            }
            
            document.getElementById('stat-disk').innerText = (rawData.stats.max_disk || '--') + ' MB/s';
            
            // 更新耗电量统计 (kWh)
            document.getElementById('stat-energy-interval').innerText = (rawData.stats.energy_interval || '0') + ' kWh';
            document.getElementById('stat-energy-total').innerText = (rawData.stats.energy_total || '0') + ' kWh';
            document.getElementById('stat-energy-date').innerText = 'since ' + (rawData.stats.energy_start_date || '--');
        }

        const dsTemp = [], dsLoad = [], dsIO = [];
        const ctxTemp = document.getElementById('chartTemp').getContext('2d');
        const ctxLoad = document.getElementById('chartLoad').getContext('2d');
        const ctxIO = document.getElementById('chartIO').getContext('2d');

        // --- 热力图表 (Temp + Fan) ---
        if(document.getElementById('chk-temp').checked) 
            dsTemp.push({label:'CPU Temp', data:rawData.cpu_temp, borderColor:'#1f6feb', backgroundColor: createGradient(ctxTemp, '#1f6feb'), fill: true});
        if(rawData.gpu && rawData.gpu.temp && document.getElementById('chk-gpu-temp').checked)
            dsTemp.push({label:'GPU Temp', data:rawData.gpu.temp, borderColor:'#39c5bb', backgroundColor: createGradient(ctxTemp, '#39c5bb'), fill: true});
        if(document.getElementById('chk-fan').checked) 
            dsTemp.push({label:'Fan Speed', data:rawData.fan_rpm, borderColor:'#3fb950', yAxisID: 'y1'});
        if(document.getElementById('chk-pwr').checked) 
            dsTemp.push({label:'Sys Power', data:rawData.power, borderColor:'#d29922', yAxisID: 'y1'});
        if(rawData.gpu && rawData.gpu.power && document.getElementById('chk-gpu-pwr').checked)
            dsTemp.push({label:'GPU Power', data:rawData.gpu.power, borderColor:'#f85149', yAxisID: 'y1'});

        // --- 负载图表 (Load + GPU Mem) ---
        if(document.getElementById('chk-cpu').checked)
            dsLoad.push({label:'CPU Util', data:rawData.cpu_load, borderColor:'#79c0ff', backgroundColor: createGradient(ctxLoad, '#79c0ff'), fill: true});
        if(document.getElementById('chk-ram').checked)
            dsLoad.push({label:'RAM Util', data:rawData.mem_load, borderColor:'#bc8cff', backgroundColor: createGradient(ctxLoad, '#bc8cff'), fill: true});
        if(rawData.gpu && rawData.gpu.util_gpu && document.getElementById('chk-gpu-util').checked)
            dsLoad.push({label:'GPU Util', data:rawData.gpu.util_gpu, borderColor:'#ff7b72', backgroundColor: createGradient(ctxLoad, '#ff7b72'), fill: true});
        if(rawData.gpu && rawData.gpu.mem_used && document.getElementById('chk-gpu-mem').checked)
            dsLoad.push({label:'GPU Mem', data:rawData.gpu.mem_used, borderColor:'#da367f', yAxisID: 'y1'});

        // --- IO 图表 ---
        if(document.getElementById('chk-net-in').checked)
            dsIO.push({label:'Net In', data:rawData.net_in, borderColor:'#2ea043'});
        if(document.getElementById('chk-net-out').checked)
            dsIO.push({label:'Net Out', data:rawData.net_out, borderColor:'#388bfd'});
        if(document.getElementById('chk-disk-r').checked)
            dsIO.push({label:'Disk R', data:rawData.disk_r, borderColor:'#d29922'});
        if(document.getElementById('chk-disk-w').checked)
            dsIO.push({label:'Disk W', data:rawData.disk_w, borderColor:'#f85149'});

        // 更新三个图表
        const updateSingleChart = (chart, ds) => {
            chart.data.labels = rawData.times;
            chart.data.datasets = ds;
            chart.options.scales.y1.display = ds.some(d => d.yAxisID === 'y1');
            chart.update();
        };

        updateSingleChart(charts.temp, dsTemp);
        updateSingleChart(charts.load, dsLoad);
        updateSingleChart(charts.io, dsIO);

        // --- 更新深度分析图表 (支持独立调用) ---
        updateInsightsCharts();
    }

    function updateInsightsCharts() {
        if (rawData.analysis) {
            const ana = rawData.analysis;

            // 1. 功耗占比 (转换成百分比展示)
            const totalPwr = (ana.cpu_power_avg || 0) + (ana.gpu_power_avg || 0);
            if (totalPwr > 0) {
                charts.pwrDist.data.datasets[0].data = [
                    (ana.cpu_power_avg / totalPwr * 100).toFixed(1),
                    (ana.gpu_power_avg / totalPwr * 100).toFixed(1)
                ];
            } else {
                charts.pwrDist.data.datasets[0].data = [0, 0];
            }
            charts.pwrDist.update();

            // 2. 负载分布
            charts.loadDist.data.datasets = [
                { label: 'CPU', data: ana.cpu_load_dist, backgroundColor: 'rgba(31, 111, 235, 0.7)' },
                { label: 'GPU', data: ana.gpu_load_dist, backgroundColor: 'rgba(57, 197, 187, 0.7)' }
            ];
            charts.loadDist.update();

            // 3. 显存效率
            charts.vramEff.data.datasets[0].data = ana.vram_efficiency;
            charts.vramEff.update();

            // 4. 温度分布 (高精度 1度步长)
            charts.tempDist.data.labels = ana.cpu_temp_labels;
            charts.tempDist.data.datasets = [
                { label: 'CPU', data: ana.cpu_temp_dist, borderColor: '#1f6feb', backgroundColor: 'rgba(31, 111, 235, 0.1)', fill: true, pointRadius: 0 },
                { label: 'GPU', data: ana.gpu_temp_dist, borderColor: '#39c5bb', backgroundColor: 'rgba(57, 197, 187, 0.1)', fill: true, pointRadius: 0 }
            ];
            charts.tempDist.update();
        }
    }

    function checkLogStatus() {
        fetch('/api/log_status').then(r => r.json()).then(d => {
            const dot = document.getElementById('log-dot');
            if (d.unread) dot.classList.remove('d-none');
            else dot.classList.add('d-none');
        });
    }

    function exportData() {
        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        window.location.href = '/api/export_data';
        
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }, 2000);
    }

    init();
    checkLogStatus();
    setInterval(checkLogStatus, 30000);
</script>
<footer class="text-center w-100 mb-2 mt-auto" style="pointer-events: none;">
    <a href="https://github.com/stlin256/IPMI_WEB" target="_blank" class="text-muted text-decoration-none small opacity-50 hover-opacity-100 transition-all" style="pointer-events: auto;">
        <i class="fab fa-github me-1"></i>GitHub @stlin256
    </a>
</footer>
</body>
</html>
