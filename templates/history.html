<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>History - {{ server_name }} Ops</title>
   <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
   <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
   <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <style>
        :root { --bg-body: #0d1117; --bg-card: #161b22; --border-color: #30363d; --text-main: #e6edf3; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: "Segoe UI", sans-serif; padding-bottom: 60px; }
        .navbar { background-color: rgba(22, 27, 34, 0.95) !important; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .nav-link { color: #8b949e !important; }
        .nav-link:hover, .nav-link.active { color: #fff !important; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; }
        .form-select { background-color: #21262d; border-color: #30363d; color: #c9d1d9; }
        
        /* 横向滚动容器 */
        .scrollable-tabs-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch; /* iOS顺滑滚动 */
            padding-bottom: 5px;
            gap: 8px;
        }
        /* 隐藏滚动条但保留功能 */
        .scrollable-tabs-container::-webkit-scrollbar { height: 4px; }
        .scrollable-tabs-container::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        
        /* 胶囊样式优化 */
        .btn-check-custom + .btn { 
            border-color: #30363d; color: #8b949e; background: rgba(255,255,255,0.02); 
            border-radius: 20px; padding: 0.375rem 1rem; font-size: 0.9rem;
            white-space: nowrap;
        }
        .btn-check-custom:hover + .btn { background: rgba(255,255,255,0.05); }

        /* Temp - Blue */
        #chk-temp:checked + .btn { background-color: rgba(31, 111, 235, 0.15); color: #58a6ff; border-color: #1f6feb; }
        /* Fan - Green */
        #chk-fan:checked + .btn { background-color: rgba(35, 134, 54, 0.15); color: #3fb950; border-color: #238636; }
        /* Power - Gold */
        #chk-pwr:checked + .btn { background-color: rgba(210, 153, 34, 0.15); color: #e3b341; border-color: #d29922; }
        /* CPU - Purple */
        #chk-cpu:checked + .btn { background-color: rgba(163, 113, 247, 0.15); color: #d2a8ff; border-color: #a371f7; }
        /* Disk/Net - Grey */
        .chk-io:checked + .btn { background-color: rgba(139, 148, 158, 0.15); color: #c9d1d9; border-color: #8b949e; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="fas fa-server me-2 text-primary"></i> <span class="fw-bold fs-4">{{ server_name }}</span></a>
        <div class="navbar-nav flex-row me-auto ms-4">
            <a class="nav-link me-3" href="/hardware">HW</a>
            <a class="nav-link me-3" href="/resources">RES</a>
            <a class="nav-link me-3" href="/gpu">GPU</a>
            <a class="nav-link active" href="/history">HIST</a>
        </div>
        <a href="/logout" class="btn btn-outline-danger"><i class="fas fa-sign-out-alt"></i></a>
    </div>
</nav>

<div class="container-fluid mt-4 px-3 px-md-4">
    <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center py-3 flex-wrap gap-2">
            <span class="fw-bold fs-5"><i class="fas fa-database me-2"></i>History Explorer</span>
            
            <div class="d-flex gap-2 align-items-center ms-auto">
                <button class="btn btn-sm btn-outline-secondary" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
                <select id="timeRange" class="form-select form-select-sm" style="width: 140px" onchange="loadData()">
                    <option value="1" selected>Last 1 Hour</option>
                    <option value="6">Last 6 Hours</option>
                    <option value="24">Last 24 Hours</option>
                    <option value="72">Last 3 Days</option>
                    <option value="168">Last 7 Days</option>
                </select>
            </div>
        </div>
        <div class="card-body d-flex flex-column">
            <!-- 维度选择器 - 可横向滑动 -->
            <div class="mb-3 scrollable-tabs-container">
                <input type="checkbox" class="btn-check btn-check-custom" id="chk-temp" checked onchange="updateChart()">
                <label class="btn" for="chk-temp"><i class="fas fa-thermometer-half me-1"></i> Temp</label>

                <input type="checkbox" class="btn-check btn-check-custom" id="chk-fan" onchange="updateChart()">
                <label class="btn" for="chk-fan"><i class="fas fa-fan me-1"></i> Fan</label>

                <input type="checkbox" class="btn-check btn-check-custom" id="chk-pwr" onchange="updateChart()">
                <label class="btn" for="chk-pwr"><i class="fas fa-bolt me-1"></i> Power</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-cpu" checked onchange="updateChart()">
               <label class="btn" for="chk-cpu"><i class="fas fa-microchip me-1"></i> CPU</label>
               
               <input type="checkbox" class="btn-check btn-check-custom chk-io" id="chk-net-in" onchange="updateChart()">
               <label class="btn" for="chk-net-in">Net In</label>

               <input type="checkbox" class="btn-check btn-check-custom chk-io" id="chk-net-out" onchange="updateChart()">
               <label class="btn" for="chk-net-out">Net Out</label>

               <input type="checkbox" class="btn-check btn-check-custom chk-io" id="chk-disk-r" onchange="updateChart()">
               <label class="btn" for="chk-disk-r">Disk Read</label>

               <input type="checkbox" class="btn-check btn-check-custom chk-io" id="chk-disk-w" onchange="updateChart()">
               <label class="btn" for="chk-disk-w">Disk Write</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-temp" onchange="updateChart()">
               <label class="btn" for="chk-gpu-temp"><i class="fas fa-microchip me-1"></i> GPU Temp</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-util" onchange="updateChart()">
               <label class="btn" for="chk-gpu-util"><i class="fas fa-percentage me-1"></i> GPU Util</label>

               <input type="checkbox" class="btn-check btn-check-custom" id="chk-gpu-pwr" onchange="updateChart()">
               <label class="btn" for="chk-gpu-pwr"><i class="fas fa-bolt me-1"></i> GPU Power</label>

               <input type="checkbox" class="btn-check btn-check-custom chk-io" id="chk-gpu-mem" onchange="updateChart()">
               <label class="btn" for="chk-gpu-mem"><i class="fas fa-memory me-1"></i> GPU Memory</label>
            </div>
            
            <div style="flex-grow: 1; min-height: 450px; width: 100%">
                <canvas id="histChart"></canvas>
            </div>
            <div id="loading" class="text-center text-muted mt-3" style="display:none"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>
        </div>
    </div>
</div>

<script>
    let chart;
    let rawData = {};

    function init() {
        const ctx = document.getElementById('histChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                elements: { point: { radius: 0, hitRadius: 20, hoverRadius: 5 } },
                plugins: {
                    legend: { labels: { color: '#c9d1d9', usePointStyle: true, boxWidth: 8 } },
                    tooltip: { backgroundColor: 'rgba(22, 27, 34, 0.95)', borderColor: '#30363d', borderWidth: 1, titleColor: '#fff', bodyColor: '#ccc' }
                },
                scales: {
                    x: { grid: { color: '#30363d', drawBorder: false }, ticks: { color: '#8b949e', maxTicksLimit: 8 } },
                    y: { type: 'linear', display: true, position: 'left', grid: { color: '#30363d', drawBorder: false }, ticks: { color: '#8b949e' } }
                }
            }
        });
        loadData();
    }

    function loadData() {
        const hours = document.getElementById('timeRange').value;
        document.getElementById('loading').style.display = 'block';
        
        // 同时请求系统历史和 GPU 历史 (默认第一块卡)
        Promise.all([
            fetch(`/api/history_custom?hours=${hours}`).then(r => r.json()),
            fetch(`/api/history_gpu?hours=${hours}&index=0`).then(r => r.json()).catch(() => ({})),
        ]).then(([sys, gpu]) => {
            rawData = sys;
            rawData.gpu = gpu;
            document.getElementById('loading').style.display = 'none';
            updateChart();
        }).catch(e => {
            console.error(e);
            document.getElementById('loading').innerText = "Error";
        });
    }

    function updateChart() {
        if (!rawData.times) return;

        const datasets = [];
        
        if(document.getElementById('chk-temp').checked) 
            datasets.push({label:'Temp (°C)', data:rawData.cpu_temp, borderColor:'#1f6feb', borderWidth:2, yAxisID:'y'});
        if(document.getElementById('chk-pwr').checked) 
            datasets.push({label:'Power (W)', data:rawData.power, borderColor:'#d29922', borderWidth:2, yAxisID:'y'});
       if(document.getElementById('chk-cpu').checked)
           datasets.push({label:'CPU (%)', data:rawData.cpu_load, borderColor:'#a371f7', borderWidth:2, yAxisID:'y'});

        if(document.getElementById('chk-fan').checked) 
            datasets.push({label:'Fan (RPM)', data:rawData.fan_rpm, borderColor:'#238636', borderWidth:2, yAxisID:'y1'});
        if(document.getElementById('chk-net-in').checked)
           datasets.push({label:'Net In (KB/s)', data:rawData.net_in, borderColor:'#3fb950', borderWidth:1, yAxisID:'y1'});
       if(document.getElementById('chk-net-out').checked)
           datasets.push({label:'Net Out (KB/s)', data:rawData.net_out, borderColor:'#3fb950', borderWidth:1, borderDash: [4,4], yAxisID:'y1'});
       if(document.getElementById('chk-disk-r').checked)
           datasets.push({label:'Disk R (MB/s)', data:rawData.disk_r, borderColor:'#dbab0a', borderWidth:1, yAxisID:'y1'});
        if(document.getElementById('chk-disk-w').checked)
           datasets.push({label:'Disk W (MB/s)', data:rawData.disk_w, borderColor:'#dbab0a', borderWidth:1, borderDash: [4,4], yAxisID:'y1'});

        // GPU 数据对接
        if(rawData.gpu && rawData.gpu.temp) {
            if(document.getElementById('chk-gpu-temp').checked)
                datasets.push({label:'GPU Temp (°C)', data:rawData.gpu.temp, borderColor:'#58a6ff', borderWidth:2, yAxisID:'y'});
            if(document.getElementById('chk-gpu-util').checked)
                datasets.push({label:'GPU Util (%)', data:rawData.gpu.util_gpu, borderColor:'#bc8cff', borderWidth:2, yAxisID:'y'});
            if(document.getElementById('chk-gpu-pwr').checked)
                datasets.push({label:'GPU Power (W)', data:rawData.gpu.power, borderColor:'#ff7b72', borderWidth:2, yAxisID:'y'});
            if(document.getElementById('chk-gpu-mem').checked)
                datasets.push({label:'GPU Memory (MB)', data:rawData.gpu.mem_used, borderColor:'#a371f7', borderWidth:2, yAxisID:'y1'});
        }

        chart.data.labels = rawData.times;
        chart.data.datasets = datasets;
        
        const hasRightAxis = datasets.some(d => d.yAxisID === 'y1');
        chart.options.scales.y1 = {
            type: 'linear', display: hasRightAxis, position: 'right', 
            grid: { drawOnChartArea: false }, 
            ticks: { color: '#8b949e' }
        };
        
        chart.update();
    }

    init();
</script>
</body>
</html>
